import{asBounds,asTRBL}from"diagram-js/lib/layout/LayoutUtil";import{is,isAny}from"../../util/ModelUtil";var DEFAULT_POSITION={x:180,y:160};export default function SubprocessCompatibility(n,t){this._eventBus=n,this._moddle=t;var e=this;n.on("import.render.start",1500,(function(n,t){e._handleImport(t.definitions)}))}function findRootDiagram(n){return is(n,"bpmndi:BPMNDiagram")?n:findRootDiagram(n.$parent)}function getPlaneBounds(n){var t={top:1/0,right:-1/0,bottom:-1/0,left:1/0};return n.planeElement.forEach((function(n){if(n.bounds){var e=asTRBL(n.bounds);t.top=Math.min(e.top,t.top),t.left=Math.min(e.left,t.left)}})),asBounds(t)}function shouldMoveToPlane(n,t){var e=n.$parent;return!(!is(e,"bpmn:SubProcess")||e===t.bpmnElement||isAny(n,["bpmn:DataInputAssociation","bpmn:DataOutputAssociation"]))}SubprocessCompatibility.prototype._handleImport=function(n){if(n.diagrams){var t=this;this._definitions=n,this._processToDiagramMap={},n.diagrams.forEach((function(n){n.plane&&n.plane.bpmnElement&&(t._processToDiagramMap[n.plane.bpmnElement.id]=n)})),n.diagrams.filter((n=>n.plane)).flatMap((n=>t._createNewDiagrams(n.plane))).forEach((function(n){t._movePlaneElementsToOrigin(n.plane)}))}},SubprocessCompatibility.prototype._createNewDiagrams=function(n){var t=this,e=[],a=[];n.get("planeElement").forEach((function(t){var i=t.bpmnElement;if(i){var o=i.$parent;is(i,"bpmn:SubProcess")&&!t.isExpanded&&e.push(i),shouldMoveToPlane(i,n)&&a.push({diElement:t,parent:o})}}));var i=[];return e.forEach((function(n){if(!t._processToDiagramMap[n.id]){var e=t._createDiagram(n);t._processToDiagramMap[n.id]=e,i.push(e)}})),a.forEach((function(n){for(var a=n.diElement,i=n.parent;i&&-1===e.indexOf(i);)i=i.$parent;if(i){var o=t._processToDiagramMap[i.id];t._moveToDiPlane(a,o.plane)}})),i},SubprocessCompatibility.prototype._movePlaneElementsToOrigin=function(n){var t=n.get("planeElement"),e=getPlaneBounds(n),a=e.x-DEFAULT_POSITION.x,i=e.y-DEFAULT_POSITION.y;t.forEach((function(n){n.waypoint?n.waypoint.forEach((function(n){n.x=n.x-a,n.y=n.y-i})):n.bounds&&(n.bounds.x=n.bounds.x-a,n.bounds.y=n.bounds.y-i)}))},SubprocessCompatibility.prototype._moveToDiPlane=function(n,t){var e=findRootDiagram(n).plane.get("planeElement");e.splice(e.indexOf(n),1),t.get("planeElement").push(n)},SubprocessCompatibility.prototype._createDiagram=function(n){var t=this._moddle.create("bpmndi:BPMNPlane",{bpmnElement:n}),e=this._moddle.create("bpmndi:BPMNDiagram",{plane:t});return t.$parent=e,t.bpmnElement=n,e.$parent=this._definitions,this._definitions.diagrams.push(e),e},SubprocessCompatibility.$inject=["eventBus","moddle"];