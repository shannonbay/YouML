import inherits from"inherits-browser";import CreateMoveSnapping from"diagram-js/lib/features/snapping/CreateMoveSnapping";import{isSnapped,setSnapped,topLeft,bottomRight}from"diagram-js/lib/features/snapping/SnapUtil";import{isExpanded}from"../../util/DiUtil";import{is}from"../../util/ModelUtil";import{asTRBL,getMid}from"diagram-js/lib/layout/LayoutUtil";import{getBoundaryAttachment}from"./BpmnSnappingUtil";import{forEach}from"min-dash";var HIGH_PRIORITY=1500;export default function BpmnCreateMoveSnapping(t,n){n.invoke(CreateMoveSnapping,this),t.on(["create.move","create.end"],HIGH_PRIORITY,setSnappedIfConstrained),t.on(["create.move","create.end","shape.move.move","shape.move.end"],HIGH_PRIORITY,(function(t){var n=t.context,e=n.canExecute,i=n.target;e&&("attach"===e||e.attach)&&!isSnapped(t)&&snapBoundaryEvent(t,i)}))}function snapBoundaryEvent(t,n){var e,i=asTRBL(n),a=getBoundaryAttachment(t,n),o=t.context.shape;e=o.parent?{x:0,y:0}:getMid(o),/top/.test(a)?setSnapped(t,"y",i.top-e.y):/bottom/.test(a)&&setSnapped(t,"y",i.bottom-e.y),/left/.test(a)?setSnapped(t,"x",i.left-e.x):/right/.test(a)&&setSnapped(t,"x",i.right-e.x)}function areAll(t,n){return t.every((function(t){return is(t,n)}))}function isContainer(t){return!(!is(t,"bpmn:SubProcess")||!isExpanded(t))||is(t,"bpmn:Participant")}function setSnappedIfConstrained(t){var n=t.context.createConstraints;if(n){var e=n.top,i=n.right,a=n.bottom,o=n.left;(o&&o>=t.x||i&&i<=t.x)&&setSnapped(t,"x",t.x),(e&&e>=t.y||a&&a<=t.y)&&setSnapped(t,"y",t.y)}}function includes(t,n){return-1!==t.indexOf(n)}function getDockingSnapOrigin(t,n,e){return n?{x:t.x-e.x,y:t.y-e.y}:{x:t.x,y:t.y}}inherits(BpmnCreateMoveSnapping,CreateMoveSnapping),BpmnCreateMoveSnapping.$inject=["eventBus","injector"],BpmnCreateMoveSnapping.prototype.initSnap=function(t){var n=CreateMoveSnapping.prototype.initSnap.call(this,t),e=t.shape,i=!!this._elementRegistry.get(e.id);return forEach(e.outgoing,(function(e){var a=e.waypoints[0];a=a.original||a,n.setSnapOrigin(e.id+"-docking",getDockingSnapOrigin(a,i,t))})),forEach(e.incoming,(function(e){var a=e.waypoints[e.waypoints.length-1];a=a.original||a,n.setSnapOrigin(e.id+"-docking",getDockingSnapOrigin(a,i,t))})),is(e,"bpmn:Participant")&&n.setSnapLocations(["top-left","bottom-right","mid"]),n},BpmnCreateMoveSnapping.prototype.addSnapTargetPoints=function(t,n,e){CreateMoveSnapping.prototype.addSnapTargetPoints.call(this,t,n,e);var i=this.getSnapTargets(n,e);forEach(i,(function(e){(isContainer(e)||areAll([n,e],"bpmn:TextAnnotation"))&&(t.add("top-left",topLeft(e)),t.add("bottom-right",bottomRight(e)))}));var a=this._elementRegistry;return forEach(n.incoming,(function(e){if(a.get(n.id)){includes(i,e.source)||t.add("mid",getMid(e.source));var o=e.waypoints[0];t.add(e.id+"-docking",o.original||o)}})),forEach(n.outgoing,(function(e){if(a.get(n.id)){includes(i,e.target)||t.add("mid",getMid(e.target));var o=e.waypoints[e.waypoints.length-1];t.add(e.id+"-docking",o.original||o)}})),is(e,"bpmn:SequenceFlow")&&(t=this.addSnapTargetPoints(t,n,e.parent)),t},BpmnCreateMoveSnapping.prototype.getSnapTargets=function(t,n){return CreateMoveSnapping.prototype.getSnapTargets.call(this,t,n).filter((function(t){return!is(t,"bpmn:Lane")}))};