import{mid,setSnapped}from"diagram-js/lib/features/snapping/SnapUtil";import{isCmd}from"diagram-js/lib/features/keyboard/KeyboardUtil";import{getOrientation}from"diagram-js/lib/layout/LayoutUtil";import{is}from"../../util/ModelUtil";import{isAny}from"../modeling/util/ModelingUtil";import{some}from"min-dash";var HIGHER_PRIORITY=1250,BOUNDARY_TO_HOST_THRESHOLD=40,TARGET_BOUNDS_PADDING=20,TASK_BOUNDS_PADDING=10,TARGET_CENTER_PADDING=20,AXES=["x","y"],abs=Math.abs;export default function BpmnConnectSnapping(n){n.on(["connect.hover","connect.move","connect.end"],HIGHER_PRIORITY,(function(n){var t=n.context,i=t.canExecute,o=t.start,e=t.hover,a=t.source,s=t.target;n.originalEvent&&isCmd(n.originalEvent)||(t.initialConnectionStart||(t.initialConnectionStart=t.connectionStart),i&&e&&snapToShape(n,e,getTargetBoundsPadding(e)),e&&isAnyType(i,["bpmn:Association","bpmn:DataInputAssociation","bpmn:DataOutputAssociation","bpmn:SequenceFlow"])?(t.connectionStart=mid(o),isAny(e,["bpmn:Event","bpmn:Gateway"])&&snapToPosition(n,mid(e)),isAny(e,["bpmn:Task","bpmn:SubProcess"])&&snapToTargetMid(n,e),is(a,"bpmn:BoundaryEvent")&&s===a.host&&snapBoundaryEventLoop(n)):isType(i,"bpmn:MessageFlow")?(is(o,"bpmn:Event")&&(t.connectionStart=mid(o)),is(e,"bpmn:Event")&&snapToPosition(n,mid(e))):t.connectionStart=t.initialConnectionStart)}))}function snapToShape(n,t,i){AXES.forEach((function(o){var e=getDimensionForAxis(o,t);n[o]<t[o]+i?setSnapped(n,o,t[o]+i):n[o]>t[o]+e-i&&setSnapped(n,o,t[o]+e-i)}))}function snapToTargetMid(n,t){var i=mid(t);AXES.forEach((function(o){isMid(n,t,o)&&setSnapped(n,o,i[o])}))}function snapBoundaryEventLoop(n){var t=n.context,i=t.source,o=t.target;if(!isReverse(t)){var e=mid(i),a=getOrientation(e,o,-10),s=[];/top|bottom/.test(a)&&s.push("x"),/left|right/.test(a)&&s.push("y"),s.forEach((function(t){var i,o=n[t];abs(o-e[t])<BOUNDARY_TO_HOST_THRESHOLD&&(i=o>e[t]?e[t]+BOUNDARY_TO_HOST_THRESHOLD:e[t]-BOUNDARY_TO_HOST_THRESHOLD,setSnapped(n,t,i))}))}}function snapToPosition(n,t){setSnapped(n,"x",t.x),setSnapped(n,"y",t.y)}function isType(n,t){return n&&n.type===t}function isAnyType(n,t){return some(t,(function(t){return isType(n,t)}))}function getDimensionForAxis(n,t){return"x"===n?t.width:t.height}function getTargetBoundsPadding(n){return is(n,"bpmn:Task")?TASK_BOUNDS_PADDING:TARGET_BOUNDS_PADDING}function isMid(n,t,i){return n[i]>t[i]+TARGET_CENTER_PADDING&&n[i]<t[i]+getDimensionForAxis(i,t)-TARGET_CENTER_PADDING}function isReverse(n){var t=n.hover,i=n.source;return t&&i&&t===i}BpmnConnectSnapping.$inject=["eventBus"];