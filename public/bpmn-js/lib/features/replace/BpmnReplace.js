import{pick,assign,filter,forEach,isArray,isUndefined,has}from"min-dash";import{is,getDi,getBusinessObject}from"../../util/ModelUtil";import{isAny}from"../modeling/util/ModelingUtil";import{isExpanded,isEventSubProcess,isHorizontal}from"../../util/DiUtil";import{getPropertyNames}from"../copy-paste/ModdleCopy";function copyProperties(e,i,t){isArray(t)||(t=[t]),forEach(t,(function(t){isUndefined(e[t])||(i[t]=e[t])}))}var CUSTOM_PROPERTIES=["cancelActivity","instantiate","eventGatewayType","triggeredByEvent","isInterrupting"];function shouldToggleCollapsed(e,i){var t=e&&has(e,"collapsed")?e.collapsed:!isExpanded(e);return t!==(i&&(has(i,"collapsed")||has(i,"isExpanded"))?has(i,"collapsed")?i.collapsed:!i.isExpanded:t)}export default function BpmnReplace(e,i,t,n,s,r){this.replaceElement=function(o,a,p){p=p||{};var d=a.type,l=o.businessObject;if(isSubProcess(l)&&"bpmn:SubProcess"===d&&shouldToggleCollapsed(o,a))return n.toggleCollapse(o),o;var c=e.create(d),h={type:d,businessObject:c,di:{}};"bpmn:ExclusiveGateway"===d&&(h.di.isMarkerVisible=!0),copyProperties(o.di,h.di,["fill","stroke","background-color","border-color","color"]);var u=intersection(getPropertyNames(l.$descriptor),getPropertyNames(c.$descriptor,!0));assign(c,pick(a,CUSTOM_PROPERTIES));var f=filter(u,(function(e){return"eventDefinitions"===e?hasEventDefinition(o,a.eventDefinitionType):"loopCharacteristics"===e?!isEventSubProcess(c):!(has(c,e)||"processRef"===e&&!1===a.isExpanded||"triggeredByEvent"===e||"isForCompensation"===e&&isEventSubProcess(c))}));if(c=t.copyElement(l,c,f),a.eventDefinitionType&&(hasEventDefinition(c,a.eventDefinitionType)||(h.eventDefinitionType=a.eventDefinitionType,h.eventDefinitionAttrs=a.eventDefinitionAttrs)),is(l,"bpmn:Activity")){if(isSubProcess(l))h.isExpanded=isExpanded(o);else if(a&&has(a,"isExpanded")){h.isExpanded=a.isExpanded;var m=i.getDefaultSize(c,{isExpanded:h.isExpanded});h.width=m.width,h.height=m.height,h.x=o.x-(h.width-o.width)/2,h.y=o.y-(h.height-o.height)/2}isExpanded(o)&&!is(l,"bpmn:Task")&&h.isExpanded&&(h.width=o.width,h.height=o.height)}if(isSubProcess(l)&&!isSubProcess(c)&&(p.moveChildren=!1),is(l,"bpmn:Participant")){!0===a.isExpanded?c.processRef=e.create("bpmn:Process"):p.moveChildren=!1;var g=isHorizontal(o);getDi(o).isHorizontal||(getDi(h).isHorizontal=g),h.width=g?o.width:i.getDefaultSize(h).width,h.height=g?i.getDefaultSize(h).height:o.height}return r.allowed("shape.resize",{shape:c})||(h.height=i.getDefaultSize(h).height,h.width=i.getDefaultSize(h).width),c.name=l.name,isAny(l,["bpmn:ExclusiveGateway","bpmn:InclusiveGateway","bpmn:Activity"])&&isAny(c,["bpmn:ExclusiveGateway","bpmn:InclusiveGateway","bpmn:Activity"])&&(c.default=l.default),a.host&&!is(l,"bpmn:BoundaryEvent")&&is(c,"bpmn:BoundaryEvent")&&(h.host=a.host),"bpmn:DataStoreReference"!==h.type&&"bpmn:DataObjectReference"!==h.type||(h.x=o.x+(o.width-h.width)/2),s.replaceElement(o,h,{...p,targetElement:a})}}function isSubProcess(e){return is(e,"bpmn:SubProcess")}function hasEventDefinition(e,i){var t=getBusinessObject(e);return i&&t.get("eventDefinitions").some((function(e){return is(e,i)}))}function intersection(e,i){return e.filter((function(e){return i.includes(e)}))}BpmnReplace.$inject=["bpmnFactory","elementFactory","moddleCopy","modeling","replace","rules"];