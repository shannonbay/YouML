import{assign}from"min-dash";import{getLabel}from"../../util/LabelUtil";import{is}from"../../util/ModelUtil";import{isAny}from"../modeling/util/ModelingUtil";import{isExpanded,isHorizontal}from"../../util/DiUtil";import{getExternalLabelMid,isLabelExternal,hasExternalLabel,isLabel}from"../../util/LabelUtil";var HIGH_PRIORITY=2e3;export default function LabelEditingProvider(i,t,e,n,a,o,s){function d(i,t){(t||isAny(i,["bpmn:Task","bpmn:TextAnnotation","bpmn:Participant"])||isCollapsedSubProcess(i))&&n.activate(i)}this._bpmnFactory=t,this._canvas=e,this._modeling=a,this._textRenderer=s,n.registerProvider(this),i.on("element.dblclick",(function(i){d(i.element,!0)})),i.on(["autoPlace.start","canvas.viewbox.changing","drag.init","element.mousedown","popupMenu.open","root.set","selection.changed"],(function(){n.isActive()&&n.complete()})),i.on(["shape.remove","connection.remove"],HIGH_PRIORITY,(function(i){n.isActive(i.element)&&n.cancel()})),i.on(["commandStack.changed"],(function(i){n.isActive()&&n.cancel()})),i.on("directEditing.activate",(function(i){o.removeResizers()})),i.on("create.end",500,(function(i){var t=i.context,e=t.shape,n=i.context.canExecute;i.isTouch||n&&(t.hints&&!1===t.hints.createElementsBehavior||d(e))})),i.on("autoPlace.end",500,(function(i){d(i.shape)}))}function isCollapsedSubProcess(i){return is(i,"bpmn:SubProcess")&&!isExpanded(i)}function isExpandedSubProcess(i){return is(i,"bpmn:SubProcess")&&isExpanded(i)}function isCollapsedPool(i){return is(i,"bpmn:Participant")&&!isExpanded(i)}function isExpandedPool(i){return is(i,"bpmn:Participant")&&isExpanded(i)}function isEmptyText(i){return!i||!i.trim()}LabelEditingProvider.$inject=["eventBus","bpmnFactory","canvas","directEditing","modeling","resizeHandles","textRenderer"],LabelEditingProvider.prototype.activate=function(i){var t=getLabel(i);if(void 0!==t){var e={text:t},n=this.getEditingBBox(i);assign(e,n);var a={},o=e.style||{};return assign(o,{backgroundColor:null,border:null}),(isAny(i,["bpmn:Task","bpmn:Participant","bpmn:Lane","bpmn:CallActivity"])||isCollapsedSubProcess(i))&&assign(a,{centerVertically:!0}),isLabelExternal(i)&&(assign(a,{autoResize:!0}),assign(o,{backgroundColor:"#ffffff",border:"1px solid #ccc"})),is(i,"bpmn:TextAnnotation")&&(assign(a,{resizable:!0,autoResize:!0}),assign(o,{backgroundColor:"#ffffff",border:"1px solid #ccc"})),assign(e,{options:a,style:o}),e}},LabelEditingProvider.prototype.getEditingBBox=function(i){var t=this._canvas,e=i.label||i,n=t.getAbsoluteBBox(e),a=n.x+n.width/2,o=n.y+n.height/2,s={x:n.x,y:n.y},d=t.zoom(),l=this._textRenderer.getDefaultStyle(),p=this._textRenderer.getExternalStyle(),r=p.fontSize*d,g=p.lineHeight,h=l.fontSize*d,x=l.lineHeight,c={fontFamily:this._textRenderer.getDefaultStyle().fontFamily,fontWeight:this._textRenderer.getDefaultStyle().fontWeight};if(is(i,"bpmn:Lane")||isExpandedPool(i)){var m=isHorizontal(i),u=m?{width:n.height,height:30*d,x:n.x-n.height/2+15*d,y:o-30*d/2}:{width:n.width,height:30*d};assign(s,u),assign(c,{fontSize:h+"px",lineHeight:x,paddingTop:7*d+"px",paddingBottom:7*d+"px",paddingLeft:5*d+"px",paddingRight:5*d+"px",transform:m?"rotate(-90deg)":null})}if(isCollapsedPool(i)){var f=isHorizontal(i),b=f?{width:n.width,height:n.height}:{width:n.height,height:n.width,x:a-n.height/2,y:o-n.width/2};assign(s,b),assign(c,{fontSize:h+"px",lineHeight:x,paddingTop:7*d+"px",paddingBottom:7*d+"px",paddingLeft:5*d+"px",paddingRight:5*d+"px",transform:f?null:"rotate(-90deg)"})}(isAny(i,["bpmn:Task","bpmn:CallActivity"])||isCollapsedSubProcess(i))&&(assign(s,{width:n.width,height:n.height}),assign(c,{fontSize:h+"px",lineHeight:x,paddingTop:7*d+"px",paddingBottom:7*d+"px",paddingLeft:5*d+"px",paddingRight:5*d+"px"})),isExpandedSubProcess(i)&&(assign(s,{width:n.width,x:n.x}),assign(c,{fontSize:h+"px",lineHeight:x,paddingTop:7*d+"px",paddingBottom:7*d+"px",paddingLeft:5*d+"px",paddingRight:5*d+"px"}));var v=90*d,y=7*d,E=4*d;if(e.labelTarget&&(assign(s,{width:v,height:n.height+y+E,x:a-v/2,y:n.y-y}),assign(c,{fontSize:r+"px",lineHeight:g,paddingTop:y+"px",paddingBottom:E+"px"})),isLabelExternal(e)&&!hasExternalLabel(e)&&!isLabel(e)){var L=getExternalLabelMid(i),P=t.getAbsoluteBBox({x:L.x,y:L.y,width:0,height:0}),w=r+y+E;assign(s,{width:v,height:w,x:P.x-v/2,y:P.y-w/2}),assign(c,{fontSize:r+"px",lineHeight:g,paddingTop:y+"px",paddingBottom:E+"px"})}return is(i,"bpmn:TextAnnotation")&&(assign(s,{width:n.width,height:n.height,minWidth:30*d,minHeight:10*d}),assign(c,{textAlign:"left",paddingTop:5*d+"px",paddingBottom:7*d+"px",paddingLeft:7*d+"px",paddingRight:5*d+"px",fontSize:h+"px",lineHeight:x})),{bounds:s,style:c}},LabelEditingProvider.prototype.update=function(i,t,e,n){var a,o;is(i,"bpmn:TextAnnotation")&&(o=this._canvas.getAbsoluteBBox(i),a={x:i.x,y:i.y,width:i.width/o.width*n.width,height:i.height/o.height*n.height}),isEmptyText(t)&&(t=null),this._modeling.updateLabel(i,t,a)};