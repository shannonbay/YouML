import{find,forEach,has,isArray,isDefined,isFunction,isObject,matchPattern,reduce,sortBy}from"min-dash";var DISALLOWED_PROPERTIES=["artifacts","dataInputAssociations","dataOutputAssociations","default","flowElements","lanes","incoming","outgoing","categoryValue"];export default function ModdleCopy(e,t,r){this._bpmnFactory=t,this._eventBus=e,this._moddle=r,e.on("moddleCopy.canCopyProperties",(function(e){var t=e.propertyNames;if(t&&t.length)return sortBy(t,(function(e){return"extensionElements"===e}))})),e.on("moddleCopy.canCopyProperty",(function(e){var t=e.parent,r=isObject(t)&&t.$descriptor,o=e.propertyName;return(!o||-1===DISALLOWED_PROPERTIES.indexOf(o))&&!(o&&r&&!find(r.properties,matchPattern({name:o})))&&void 0})),e.on("moddleCopy.canSetCopiedProperty",(function(e){var t=e.property;if(is(t,"bpmn:ExtensionElements")&&(!t.values||!t.values.length))return!1}))}ModdleCopy.$inject=["eventBus","bpmnFactory","moddle"],ModdleCopy.prototype.copyElement=function(e,t,r,o=!1){var n=this;r&&!isArray(r)&&(r=[r]),r=r||getPropertyNames(e.$descriptor);var i=this._eventBus.fire("moddleCopy.canCopyProperties",{propertyNames:r,sourceElement:e,targetElement:t,clone:o});return!1===i||(isArray(i)&&(r=i),forEach(r,(function(r){var i;has(e,r)&&(i=e.get(r));var p=n.copyProperty(i,t,r,o);isDefined(p)&&!1!==n._eventBus.fire("moddleCopy.canSetCopiedProperty",{parent:t,property:p,propertyName:r})&&t.set(r,p)}))),t},ModdleCopy.prototype.copyProperty=function(e,t,r,o=!1){var n=this,i=this._eventBus.fire("moddleCopy.canCopyProperty",{parent:t,property:e,propertyName:r,clone:o});if(!1!==i){if(i)return isObject(i)&&i.$type&&!i.$parent&&(i.$parent=t),i;var p=this._moddle.getPropertyDescriptor(t,r);if(!p.isReference){if(p.isId)return e&&this._copyId(e,t,o);if(isArray(e))return reduce(e,(function(e,p){return(i=n.copyProperty(p,t,r,o))?e.concat(i):e}),[]);if(isObject(e)&&e.$type){if(this._moddle.getElementDescriptor(e).isGeneric)return;return(i=n._bpmnFactory.create(e.$type)).$parent=t,i=n.copyElement(e,i,null,o)}return e}}},ModdleCopy.prototype._copyId=function(e,t,r=!1){return r?e:this._moddle.ids.assigned(e)?void 0:(this._moddle.ids.claim(e,t),e)};export function getPropertyNames(e,t){return reduce(e.properties,(function(e,r){return t&&r.default?e:e.concat(r.name)}),[])}function is(e,t){return e&&isFunction(e.$instanceOf)&&e.$instanceOf(t)}