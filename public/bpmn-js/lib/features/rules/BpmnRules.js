import{every,find,forEach,some}from"min-dash";import inherits from"inherits-browser";import{is,getBusinessObject}from"../../util/ModelUtil";import{getParent,isAny}from"../modeling/util/ModelingUtil";import{isLabel}from"../../util/LabelUtil";import{isExpanded,isEventSubProcess,isInterrupting,hasErrorEventDefinition,hasEscalationEventDefinition,hasCompensateEventDefinition}from"../../util/DiUtil";import RuleProvider from"diagram-js/lib/features/rules/RuleProvider";import{getBoundaryAttachment as isBoundaryAttachment}from"../snapping/BpmnSnappingUtil";import{isConnection}from"diagram-js/lib/util/ModelUtil";export default function BpmnRules(n){RuleProvider.call(this,n)}function canStartConnection(n){return nonExistingOrLabel(n)?null:isAny(n,["bpmn:FlowNode","bpmn:InteractionNode","bpmn:DataObjectReference","bpmn:DataStoreReference","bpmn:Group","bpmn:TextAnnotation"])}function nonExistingOrLabel(n){return!n||isLabel(n)}function isSame(n,e){return n===e}function getOrganizationalParent(n){do{if(is(n,"bpmn:Process"))return getBusinessObject(n);if(is(n,"bpmn:Participant"))return getBusinessObject(n).processRef||getBusinessObject(n)}while(n=n.parent)}function isTextAnnotation(n){return is(n,"bpmn:TextAnnotation")}function isGroup(n){return is(n,"bpmn:Group")&&!n.labelTarget}function isCompensationBoundary(n){return is(n,"bpmn:BoundaryEvent")&&hasEventDefinition(n,"bpmn:CompensateEventDefinition")}function isForCompensation(n){return getBusinessObject(n).isForCompensation}function isSameOrganization(n,e){return getOrganizationalParent(n)===getOrganizationalParent(e)}function isMessageFlowSource(n){return is(n,"bpmn:InteractionNode")&&!is(n,"bpmn:BoundaryEvent")&&(!is(n,"bpmn:Event")||is(n,"bpmn:ThrowEvent")&&hasEventDefinitionOrNone(n,"bpmn:MessageEventDefinition"))}function isMessageFlowTarget(n){return is(n,"bpmn:InteractionNode")&&!isForCompensation(n)&&(!is(n,"bpmn:Event")||is(n,"bpmn:CatchEvent")&&hasEventDefinitionOrNone(n,"bpmn:MessageEventDefinition"))&&!(is(n,"bpmn:BoundaryEvent")&&!hasEventDefinition(n,"bpmn:MessageEventDefinition"))}function getScopeParent(n){for(var e=n;e=e.parent;){if(is(e,"bpmn:FlowElementsContainer"))return getBusinessObject(e);if(is(e,"bpmn:Participant"))return getBusinessObject(e).processRef}return null}function isSameScope(n,e){return getScopeParent(n)===getScopeParent(e)}function hasEventDefinition(n,e){var t=getBusinessObject(n);return!!find(t.eventDefinitions||[],(function(n){return is(n,e)}))}function hasEventDefinitionOrNone(n,e){return(getBusinessObject(n).eventDefinitions||[]).every((function(n){return is(n,e)}))}function isSequenceFlowSource(n){return is(n,"bpmn:FlowNode")&&!is(n,"bpmn:EndEvent")&&!isEventSubProcess(n)&&!(is(n,"bpmn:IntermediateThrowEvent")&&hasEventDefinition(n,"bpmn:LinkEventDefinition"))&&!isCompensationBoundary(n)&&!isForCompensation(n)}function isSequenceFlowTarget(n){return is(n,"bpmn:FlowNode")&&!is(n,"bpmn:StartEvent")&&!is(n,"bpmn:BoundaryEvent")&&!isEventSubProcess(n)&&!(is(n,"bpmn:IntermediateCatchEvent")&&hasEventDefinition(n,"bpmn:LinkEventDefinition"))&&!isForCompensation(n)}function isEventBasedTarget(n){return is(n,"bpmn:ReceiveTask")||is(n,"bpmn:IntermediateCatchEvent")&&(hasEventDefinition(n,"bpmn:MessageEventDefinition")||hasEventDefinition(n,"bpmn:TimerEventDefinition")||hasEventDefinition(n,"bpmn:ConditionalEventDefinition")||hasEventDefinition(n,"bpmn:SignalEventDefinition"))}function getParents(n){for(var e=[];n;)(n=n.parent)&&e.push(n);return e}function isParent(n,e){return-1!==getParents(e).indexOf(n)}function canConnect(n,e,t){if(nonExistingOrLabel(n)||nonExistingOrLabel(e))return null;if(!is(t,"bpmn:DataAssociation")){if(canConnectMessageFlow(n,e))return{type:"bpmn:MessageFlow"};if(canConnectSequenceFlow(n,e))return{type:"bpmn:SequenceFlow"}}return canConnectDataAssociation(n,e)||(canConnectCompensationAssociation(n,e)?{type:"bpmn:Association",associationDirection:"One"}:!!canConnectAssociation(n,e)&&{type:"bpmn:Association",associationDirection:"None"})}function canDrop(n,e){return!(!isLabel(n)&&!isGroup(n))||!(is(e,"bpmn:Participant")&&!isExpanded(e))&&(is(n,"bpmn:Participant")?is(e,"bpmn:Process")||is(e,"bpmn:Collaboration"):isAny(n,["bpmn:DataInput","bpmn:DataOutput"])&&n.parent?e===n.parent:is(n,"bpmn:Lane")?is(e,"bpmn:Participant")||is(e,"bpmn:Lane"):!(is(n,"bpmn:BoundaryEvent")&&!isDroppableBoundaryEvent(n))&&(is(n,"bpmn:FlowElement")&&!is(n,"bpmn:DataStoreReference")?is(e,"bpmn:FlowElementsContainer")?isExpanded(e):isAny(e,["bpmn:Participant","bpmn:Lane"]):is(n,"bpmn:DataStoreReference")&&is(e,"bpmn:Collaboration")?some(getBusinessObject(e).get("participants"),(function(n){return!!n.get("processRef")})):isAny(n,["bpmn:Artifact","bpmn:DataAssociation","bpmn:DataStoreReference"])?isAny(e,["bpmn:Collaboration","bpmn:Lane","bpmn:Participant","bpmn:Process","bpmn:SubProcess"]):!!is(n,"bpmn:MessageFlow")&&(is(e,"bpmn:Collaboration")||n.source.parent==e||n.target.parent==e)))}function isDroppableBoundaryEvent(n){return getBusinessObject(n).cancelActivity&&(hasNoEventDefinition(n)||hasCommonBoundaryIntermediateEventDefinition(n))}function isBoundaryEvent(n){return!isLabel(n)&&is(n,"bpmn:BoundaryEvent")}function isLane(n){return is(n,"bpmn:Lane")}function isBoundaryCandidate(n){return!!isBoundaryEvent(n)||!(!is(n,"bpmn:IntermediateThrowEvent")||!hasNoEventDefinition(n))||is(n,"bpmn:IntermediateCatchEvent")&&hasCommonBoundaryIntermediateEventDefinition(n)}function hasNoEventDefinition(n){var e=getBusinessObject(n);return e&&!(e.eventDefinitions&&e.eventDefinitions.length)}function hasCommonBoundaryIntermediateEventDefinition(n){return hasOneOfEventDefinitions(n,["bpmn:MessageEventDefinition","bpmn:TimerEventDefinition","bpmn:SignalEventDefinition","bpmn:ConditionalEventDefinition"])}function hasOneOfEventDefinitions(n,e){return e.some((function(e){return hasEventDefinition(n,e)}))}function isReceiveTaskAfterEventBasedGateway(n){return is(n,"bpmn:ReceiveTask")&&find(n.incoming,(function(n){return is(n.source,"bpmn:EventBasedGateway")}))}function canAttach(n,e,t,i){if(Array.isArray(n)||(n=[n]),1!==n.length)return!1;var o=n[0];return!isLabel(o)&&!!isBoundaryCandidate(o)&&!isEventSubProcess(e)&&!(!is(e,"bpmn:Activity")||isForCompensation(e))&&!(i&&!isBoundaryAttachment(i,e))&&!isReceiveTaskAfterEventBasedGateway(e)&&"attach"}function canReplace(n,e,t){if(!e)return!1;var i={replacements:[]};return forEach(n,(function(n){isEventSubProcess(e)||is(n,"bpmn:StartEvent")&&"label"!==n.type&&canDrop(n,e)&&(isInterrupting(n)||i.replacements.push({oldElementId:n.id,newElementType:"bpmn:StartEvent"}),(hasErrorEventDefinition(n)||hasEscalationEventDefinition(n)||hasCompensateEventDefinition(n))&&i.replacements.push({oldElementId:n.id,newElementType:"bpmn:StartEvent"}),hasOneOfEventDefinitions(n,["bpmn:MessageEventDefinition","bpmn:TimerEventDefinition","bpmn:SignalEventDefinition","bpmn:ConditionalEventDefinition"])&&is(e,"bpmn:SubProcess")&&i.replacements.push({oldElementId:n.id,newElementType:"bpmn:StartEvent"})),is(e,"bpmn:Transaction")||hasEventDefinition(n,"bpmn:CancelEventDefinition")&&"label"!==n.type&&(is(n,"bpmn:EndEvent")&&canDrop(n,e)&&i.replacements.push({oldElementId:n.id,newElementType:"bpmn:EndEvent"}),is(n,"bpmn:BoundaryEvent")&&canAttach(n,e,null,t)&&i.replacements.push({oldElementId:n.id,newElementType:"bpmn:BoundaryEvent"}))})),!!i.replacements.length&&i}function canMove(n,e){return!some(n,isLane)&&(!e||n.every((function(n){return canDrop(n,e)})))}function canCreate(n,e,t,i){return!!e&&(!(!isLabel(n)&&!isGroup(n))||!isSame(t,e)&&(!t||!isParent(t,e))&&(canDrop(n,e,i)||canInsert(n,e,i)))}function canResize(n,e){return is(n,"bpmn:SubProcess")?isExpanded(n)&&(!e||e.width>=100&&e.height>=80):!!(is(n,"bpmn:Lane")||is(n,"bpmn:Participant")||isTextAnnotation(n)||isGroup(n))}function isOneTextAnnotation(n,e){var t=isTextAnnotation(n),i=isTextAnnotation(e);return(t||i)&&t!==i}function canConnectAssociation(n,e){return!(isParent(e,n)||isParent(n,e)||!isOneTextAnnotation(n,e)&&!canConnectDataAssociation(n,e))}function canConnectCompensationAssociation(n,e){return isSameScope(n,e)&&isCompensationBoundary(n)&&is(e,"bpmn:Activity")&&!isHostOfElement(e,n)&&!isEventSubProcess(e)}function canConnectMessageFlow(n,e){return!(getRootElement(n)&&!getRootElement(e))&&isMessageFlowSource(n)&&isMessageFlowTarget(e)&&!isSameOrganization(n,e)}function canConnectSequenceFlow(n,e){return isSequenceFlowSource(n)&&isSequenceFlowTarget(e)&&isSameScope(n,e)&&!(is(n,"bpmn:EventBasedGateway")&&!isEventBasedTarget(e))}function canConnectDataAssociation(n,e){return isAny(n,["bpmn:DataObjectReference","bpmn:DataStoreReference"])&&isAny(e,["bpmn:Activity","bpmn:ThrowEvent"])?{type:"bpmn:DataInputAssociation"}:!(!isAny(e,["bpmn:DataObjectReference","bpmn:DataStoreReference"])||!isAny(n,["bpmn:Activity","bpmn:CatchEvent"]))&&{type:"bpmn:DataOutputAssociation"}}function canInsert(n,e,t){if(!e)return!1;if(Array.isArray(n)){if(1!==n.length)return!1;n=n[0]}return e.source!==n&&e.target!==n&&isAny(e,["bpmn:SequenceFlow","bpmn:MessageFlow"])&&!isLabel(e)&&is(n,"bpmn:FlowNode")&&!is(n,"bpmn:BoundaryEvent")&&canDrop(n,e.parent,t)}function includes(n,e){return n&&e&&-1!==n.indexOf(e)}function canCopy(n,e){return!!isLabel(e)||!(is(e,"bpmn:Lane")&&!includes(n,e.parent))}function getRootElement(n){return getParent(n,"bpmn:Process")||getParent(n,"bpmn:Collaboration")}function isHostOfElement(n,e){return n.attachers.includes(e)}inherits(BpmnRules,RuleProvider),BpmnRules.$inject=["eventBus"],BpmnRules.prototype.init=function(){this.addRule("connection.start",(function(n){return canStartConnection(n.source)})),this.addRule("connection.create",(function(n){var e=n.source,t=n.target,i=n.hints||{},o=i.targetParent;if(i.targetAttach)return!1;o&&(t.parent=o);try{return canConnect(e,t)}finally{o&&(t.parent=null)}})),this.addRule("connection.reconnect",(function(n){var e=n.connection;return canConnect(n.source,n.target,e)})),this.addRule("connection.updateWaypoints",(function(n){return{type:n.connection.type}})),this.addRule("shape.resize",(function(n){return canResize(n.shape,n.newBounds)})),this.addRule("elements.create",(function(n){var e=n.elements,t=n.position,i=n.target;return!(isConnection(i)&&!canInsert(e,i,t))&&every(e,(function(n){return isConnection(n)?canConnect(n.source,n.target,n):n.host?canAttach(n,n.host,null,t):canCreate(n,i,null,t)}))})),this.addRule("elements.move",(function(n){var e=n.target,t=n.shapes,i=n.position;return canAttach(t,e,null,i)||canReplace(t,e,i)||canMove(t,e,i)||canInsert(t,e,i)})),this.addRule("shape.create",(function(n){return canCreate(n.shape,n.target,n.source,n.position)})),this.addRule("shape.attach",(function(n){return canAttach(n.shape,n.target,null,n.position)})),this.addRule("element.copy",(function(n){var e=n.element;return canCopy(n.elements,e)}))},BpmnRules.prototype.canConnectMessageFlow=canConnectMessageFlow,BpmnRules.prototype.canConnectSequenceFlow=canConnectSequenceFlow,BpmnRules.prototype.canConnectDataAssociation=canConnectDataAssociation,BpmnRules.prototype.canConnectAssociation=canConnectAssociation,BpmnRules.prototype.canConnectCompensationAssociation=canConnectCompensationAssociation,BpmnRules.prototype.canMove=canMove,BpmnRules.prototype.canAttach=canAttach,BpmnRules.prototype.canReplace=canReplace,BpmnRules.prototype.canDrop=canDrop,BpmnRules.prototype.canInsert=canInsert,BpmnRules.prototype.canCreate=canCreate,BpmnRules.prototype.canConnect=canConnect,BpmnRules.prototype.canResize=canResize,BpmnRules.prototype.canCopy=canCopy;