import{getBusinessObject,is}from"../../util/ModelUtil";import{isEventSubProcess,isExpanded}from"../../util/DiUtil";import{isDifferentType}from"./util/TypeUtil";import{forEach,filter,isArray}from"min-dash";import*as replaceOptions from"../replace/ReplaceOptions";import{canBeNonInterrupting,getInterruptingProperty}from"../modeling/behavior/util/NonInterruptingUtil";import Icons from"./util/Icons";export default function ReplaceMenuProvider(e,t,i,n,r,s,a,o){this._bpmnFactory=e,this._popupMenu=t,this._modeling=i,this._moddle=n,this._bpmnReplace=r,this._rules=s,this._translate=a,this._moddleCopy=o,this._register()}ReplaceMenuProvider.$inject=["bpmnFactory","popupMenu","modeling","moddle","bpmnReplace","rules","translate","moddleCopy"],ReplaceMenuProvider.prototype._register=function(){this._popupMenu.registerProvider("bpmn-replace",this)},ReplaceMenuProvider.prototype.getPopupMenuEntries=function(e){var t=e.businessObject,i=this._rules,n=[];if(isArray(e)||!i.allowed("shape.replace",{element:e}))return{};var r=isDifferentType(e);return is(t,"bpmn:DataObjectReference")?this._createEntries(e,replaceOptions.DATA_OBJECT_REFERENCE):is(t,"bpmn:DataStoreReference")&&!is(e.parent,"bpmn:Collaboration")?this._createEntries(e,replaceOptions.DATA_STORE_REFERENCE):is(t,"bpmn:StartEvent")&&!is(t.$parent,"bpmn:SubProcess")?(n=filter(replaceOptions.START_EVENT,r),this._createEntries(e,n)):is(t,"bpmn:Participant")?(n=filter(replaceOptions.PARTICIPANT,(function(t){return isExpanded(e)!==t.target.isExpanded})),this._createEntries(e,n)):is(t,"bpmn:StartEvent")&&isEventSubProcess(t.$parent)?(n=filter(replaceOptions.EVENT_SUB_PROCESS_START_EVENT,(function(e){var i=!1!==e.target.isInterrupting,n=t.isInterrupting===i;return r(e)||!r(e)&&!n})),this._createEntries(e,n)):is(t,"bpmn:StartEvent")&&!isEventSubProcess(t.$parent)&&is(t.$parent,"bpmn:SubProcess")?(n=filter(replaceOptions.START_EVENT_SUB_PROCESS,r),this._createEntries(e,n)):is(t,"bpmn:EndEvent")?(n=filter(replaceOptions.END_EVENT,(function(e){return!("bpmn:CancelEventDefinition"==e.target.eventDefinitionType&&!is(t.$parent,"bpmn:Transaction"))&&r(e)})),this._createEntries(e,n)):is(t,"bpmn:BoundaryEvent")?(n=filter(replaceOptions.BOUNDARY_EVENT,(function(e){var i=e.target;if("bpmn:CancelEventDefinition"==i.eventDefinitionType&&!is(t.attachedToRef,"bpmn:Transaction"))return!1;var n=!1!==i.cancelActivity,s=t.cancelActivity==n;return r(e)||!r(e)&&!s})),this._createEntries(e,n)):is(t,"bpmn:IntermediateCatchEvent")||is(t,"bpmn:IntermediateThrowEvent")?(n=filter(replaceOptions.INTERMEDIATE_EVENT,r),this._createEntries(e,n)):is(t,"bpmn:Gateway")?(n=filter(replaceOptions.GATEWAY,r),this._createEntries(e,n)):is(t,"bpmn:Transaction")?(n=filter(replaceOptions.TRANSACTION,r),this._createEntries(e,n)):isEventSubProcess(t)&&isExpanded(e)?(n=filter(replaceOptions.EVENT_SUB_PROCESS,r),this._createEntries(e,n)):is(t,"bpmn:SubProcess")&&isExpanded(e)?(n=filter(replaceOptions.SUBPROCESS_EXPANDED,r),this._createEntries(e,n)):is(t,"bpmn:AdHocSubProcess")&&!isExpanded(e)?(n=filter(replaceOptions.TASK,(function(e){var t=e.target,i="bpmn:SubProcess"===t.type,n=!0===t.isExpanded;return isDifferentType(t,t)&&(!i||n)})),this._createEntries(e,n)):is(t,"bpmn:SequenceFlow")?this._createSequenceFlowEntries(e,replaceOptions.SEQUENCE_FLOW):is(t,"bpmn:FlowNode")?(n=filter(replaceOptions.TASK,r),is(t,"bpmn:SubProcess")&&!isExpanded(e)&&(n=filter(n,(function(e){return"Sub-process (collapsed)"!==e.label}))),this._createEntries(e,n)):{}},ReplaceMenuProvider.prototype.getPopupMenuHeaderEntries=function(e){var t={};return is(e,"bpmn:Activity")&&!isEventSubProcess(e)&&(t={...t,...this._getLoopCharacteristicsHeaderEntries(e)}),is(e,"bpmn:DataObjectReference")&&(t={...t,...this._getCollectionHeaderEntries(e)}),is(e,"bpmn:Participant")&&(t={...t,...this._getParticipantMultiplicityHeaderEntries(e)}),!is(e,"bpmn:SubProcess")||is(e,"bpmn:Transaction")||isEventSubProcess(e)||(t={...t,...this._getAdHocHeaderEntries(e)}),canBeNonInterrupting(e)&&(t={...t,...this._getNonInterruptingHeaderEntries(e)}),t},ReplaceMenuProvider.prototype._createEntries=function(e,t){var i={},n=this;return forEach(t,(function(t){i[t.actionName]=n._createEntry(t,e)})),i},ReplaceMenuProvider.prototype._createSequenceFlowEntries=function(e,t){var i=getBusinessObject(e),n={},r=this._modeling,s=this._moddle,a=this;return forEach(t,(function(t){switch(t.actionName){case"replace-with-default-flow":i.sourceRef.default!==i&&(is(i.sourceRef,"bpmn:ExclusiveGateway")||is(i.sourceRef,"bpmn:InclusiveGateway")||is(i.sourceRef,"bpmn:ComplexGateway")||is(i.sourceRef,"bpmn:Activity"))&&(n={...n,[t.actionName]:a._createEntry(t,e,(function(){r.updateProperties(e.source,{default:i})}))});break;case"replace-with-conditional-flow":!i.conditionExpression&&is(i.sourceRef,"bpmn:Activity")&&(n={...n,[t.actionName]:a._createEntry(t,e,(function(){var t=s.create("bpmn:FormalExpression",{body:""});r.updateProperties(e,{conditionExpression:t})}))});break;default:is(i.sourceRef,"bpmn:Activity")&&i.conditionExpression&&(n={...n,[t.actionName]:a._createEntry(t,e,(function(){r.updateProperties(e,{conditionExpression:void 0})}))}),(is(i.sourceRef,"bpmn:ExclusiveGateway")||is(i.sourceRef,"bpmn:InclusiveGateway")||is(i.sourceRef,"bpmn:ComplexGateway")||is(i.sourceRef,"bpmn:Activity"))&&i.sourceRef.default===i&&(n={...n,[t.actionName]:a._createEntry(t,e,(function(){r.updateProperties(e.source,{default:void 0})}))})}})),n},ReplaceMenuProvider.prototype._createEntry=function(e,t,i){var n=this._translate,r=this._bpmnReplace.replaceElement,s=e.label;return s&&"function"==typeof s&&(s=s(t)),i=i||function(){return r(t,e.target)},{label:n(s),className:e.className,action:i}},ReplaceMenuProvider.prototype._getLoopCharacteristicsHeaderEntries=function(e){var t=this,i=this._translate;function n(i,n){if(n.active)return void t._modeling.updateProperties(e,{loopCharacteristics:void 0});const r=e.businessObject.get("loopCharacteristics"),s=t._moddle.create(n.options.loopCharacteristics);r&&t._moddleCopy.copyElement(r,s),s.set("isSequential",n.options.isSequential),t._modeling.updateProperties(e,{loopCharacteristics:s})}var r,s,a,o=getBusinessObject(e).loopCharacteristics;return o&&(r=o.isSequential,s=void 0===o.isSequential,a=void 0!==o.isSequential&&!o.isSequential),{"toggle-parallel-mi":{className:"bpmn-icon-parallel-mi-marker",title:i("Parallel multi-instance"),active:a,action:n,options:{loopCharacteristics:"bpmn:MultiInstanceLoopCharacteristics",isSequential:!1}},"toggle-sequential-mi":{className:"bpmn-icon-sequential-mi-marker",title:i("Sequential multi-instance"),active:r,action:n,options:{loopCharacteristics:"bpmn:MultiInstanceLoopCharacteristics",isSequential:!0}},"toggle-loop":{className:"bpmn-icon-loop-marker",title:i("Loop"),active:s,action:n,options:{loopCharacteristics:"bpmn:StandardLoopCharacteristics"}}}},ReplaceMenuProvider.prototype._getCollectionHeaderEntries=function(e){var t=this,i=this._translate,n=e.businessObject.dataObjectRef;if(!n)return{};var r=n.isCollection;return{"toggle-is-collection":{className:"bpmn-icon-parallel-mi-marker",title:i("Collection"),active:r,action:function(i,r){t._modeling.updateModdleProperties(e,n,{isCollection:!r.active})}}}},ReplaceMenuProvider.prototype._getParticipantMultiplicityHeaderEntries=function(e){var t=this,i=this._bpmnFactory,n=this._translate,r=e.businessObject.participantMultiplicity;return{"toggle-participant-multiplicity":{className:"bpmn-icon-parallel-mi-marker",title:n("Participant multiplicity"),active:!!r,action:function(n,r){var s;r.active||(s=i.create("bpmn:ParticipantMultiplicity")),t._modeling.updateProperties(e,{participantMultiplicity:s})}}}},ReplaceMenuProvider.prototype._getAdHocHeaderEntries=function(e){var t=this._translate,i=getBusinessObject(e),n=is(i,"bpmn:AdHocSubProcess"),r=this._bpmnReplace.replaceElement;return{"toggle-adhoc":{className:"bpmn-icon-ad-hoc-marker",title:t("Ad-hoc"),active:n,action:function(t,i){return r(e,n?{type:"bpmn:SubProcess"}:{type:"bpmn:AdHocSubProcess"},{autoResize:!1,layoutConnection:!1})}}}},ReplaceMenuProvider.prototype._getNonInterruptingHeaderEntries=function(e){const t=this._translate,i=getBusinessObject(e),n=this,r=getInterruptingProperty(e),s=is(e,"bpmn:BoundaryEvent")?Icons["intermediate-event-non-interrupting"]:Icons["start-event-non-interrupting"],a=!i[r];return{"toggle-non-interrupting":{imageHtml:s,title:t("Toggle non-interrupting"),active:a,action:function(){n._modeling.updateProperties(e,{[r]:!!a})}}}};