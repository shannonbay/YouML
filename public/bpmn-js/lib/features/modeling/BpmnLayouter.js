import inherits from"inherits-browser";import{assign}from"min-dash";import BaseLayouter from"diagram-js/lib/layout/BaseLayouter";import{repairConnection,withoutRedundantPoints}from"diagram-js/lib/layout/ManhattanLayout";import{getMid,getOrientation}from"diagram-js/lib/layout/LayoutUtil";import{isExpanded}from"../../util/DiUtil";import{is}from"../../util/ModelUtil";import{isDirectionHorizontal}from"./util/ModelingUtil";var ATTACH_ORIENTATION_PADDING=-10,BOUNDARY_TO_HOST_THRESHOLD=40,PREFERRED_LAYOUTS_HORIZONTAL={default:["h:h"],fromGateway:["v:h"],toGateway:["h:v"],loop:{fromTop:["t:r"],fromRight:["r:b"],fromLeft:["l:t"],fromBottom:["b:l"]},boundaryLoop:{alternateHorizontalSide:"b",alternateVerticalSide:"l",default:"v"},messageFlow:["straight","v:v"],subProcess:["straight","h:h"],isHorizontal:!0},PREFERRED_LAYOUTS_VERTICAL={default:["v:v"],fromGateway:["h:v"],toGateway:["v:h"],loop:{fromTop:["t:l"],fromRight:["r:t"],fromLeft:["l:b"],fromBottom:["b:r"]},boundaryLoop:{alternateHorizontalSide:"t",alternateVerticalSide:"r",default:"h"},messageFlow:["straight","h:h"],subProcess:["straight","v:v"],isHorizontal:!1},oppositeOrientationMapping={top:"bottom","top-right":"bottom-left","top-left":"bottom-right",right:"left",bottom:"top","bottom-right":"top-left","bottom-left":"top-right",left:"right"},orientationDirectionMapping={top:"t",right:"r",bottom:"b",left:"l"};export default function BpmnLayouter(t){this._elementRegistry=t}function getAttachOrientation(t){var e=t.host;return getOrientation(getMid(t),e,ATTACH_ORIENTATION_PADDING)}function getMessageFlowManhattanOptions(t,e,o){return{preferredLayouts:o.messageFlow,preserveDocking:getMessageFlowPreserveDocking(t,e)}}function getMessageFlowPreserveDocking(t,e){return is(e,"bpmn:Participant")?"source":is(t,"bpmn:Participant")?"target":isExpandedSubProcess(e)?"source":isExpandedSubProcess(t)||is(e,"bpmn:Event")?"target":is(t,"bpmn:Event")?"source":null}function getSubProcessPreserveDocking(t){return isExpandedSubProcess(t)?"target":"source"}function getConnectionDocking(t,e){return t?t.original||t:getMid(e)}function isCompensationAssociation(t,e){return is(e,"bpmn:Activity")&&is(t,"bpmn:BoundaryEvent")&&e.businessObject.isForCompensation}function isExpandedSubProcess(t){return is(t,"bpmn:SubProcess")&&isExpanded(t)}function isSame(t,e){return t===e}function isAnyOrientation(t,e){return-1!==e.indexOf(t)}function getHorizontalOrientation(t){var e=/right|left/.exec(t);return e&&e[0]}function getVerticalOrientation(t){var e=/top|bottom/.exec(t);return e&&e[0]}function isOppositeOrientation(t,e){return oppositeOrientationMapping[t]===e}function isOppositeHorizontalOrientation(t,e){var o=getHorizontalOrientation(t),i=oppositeOrientationMapping[o];return-1!==e.indexOf(i)}function isOppositeVerticalOrientation(t,e){var o=getVerticalOrientation(t),i=oppositeOrientationMapping[o];return-1!==e.indexOf(i)}function isHorizontalOrientation(t){return"right"===t||"left"===t}function getLoopPreferredLayout(t,e,o){var i=e.waypoints,n=i&&i.length&&getOrientation(i[0],t);return"top"===n?o.loop.fromTop:"right"===n?o.loop.fromRight:"left"===n?o.loop.fromLeft:o.loop.fromBottom}function getBoundaryEventPreferredLayouts(t,e,o,i){var n=getMid(t),r=getMid(e),a=getAttachOrientation(t),s=isSame(t.host,e),u=isAnyOrientation(a,["top","right","bottom","left"]),p=getOrientation(r,n,{x:t.width/2+e.width/2,y:t.height/2+e.height/2});return s?getBoundaryEventLoopLayout(a,u,t,e,o,i):[getBoundaryEventSourceLayout(a,p,u,i.isHorizontal)+":"+getBoundaryEventTargetLayout(a,p,u,i.isHorizontal)]}function getBoundaryEventLoopLayout(t,e,o,i,n,r){var a=e?t:r.isHorizontal?getVerticalOrientation(t):getHorizontalOrientation(t);return[orientationDirectionMapping[a]+":"+(e?isHorizontalOrientation(t)?shouldConnectToSameSide("y",o,i,n)?"h":r.boundaryLoop.alternateHorizontalSide:shouldConnectToSameSide("x",o,i,n)?"v":r.boundaryLoop.alternateVerticalSide:r.boundaryLoop.default)]}function shouldConnectToSameSide(t,e,o,i){var n=BOUNDARY_TO_HOST_THRESHOLD;return!(areCloseOnAxis(t,i,o,n)||areCloseOnAxis(t,i,{x:o.x+o.width,y:o.y+o.height},n)||areCloseOnAxis(t,i,getMid(e),n))}function areCloseOnAxis(t,e,o,i){return Math.abs(e[t]-o[t])<i}function getBoundaryEventSourceLayout(t,e,o,i){if(o)return orientationDirectionMapping[t];var n=getVerticalOrientation(t),r=getHorizontalOrientation(t),a=getVerticalOrientation(e),s=getHorizontalOrientation(e);if(i){if(isSame(n,a)||isOppositeOrientation(r,s))return orientationDirectionMapping[n]}else if(isSame(r,s)||isOppositeOrientation(n,a))return orientationDirectionMapping[r];return orientationDirectionMapping[i?r:n]}function getBoundaryEventTargetLayout(t,e,o,i){return o?isHorizontalOrientation(t)?isOppositeHorizontalOrientation(t,e)||isSame(t,e)?"h":"v":isOppositeVerticalOrientation(t,e)||isSame(t,e)?"v":"h":i?isSame(getVerticalOrientation(t),getVerticalOrientation(e))?"h":"v":isSame(getHorizontalOrientation(t),getHorizontalOrientation(e))?"v":"h"}inherits(BpmnLayouter,BaseLayouter),BpmnLayouter.prototype.layoutConnection=function(t,e){e||(e={});var o,i,n=e.source||t.source,r=e.target||t.target,a=e.waypoints||t.waypoints,s=e.connectionStart,u=e.connectionEnd,p=this._elementRegistry;if(s||(s=getConnectionDocking(a&&a[0],n)),u||(u=getConnectionDocking(a&&a[a.length-1],r)),(is(t,"bpmn:Association")||is(t,"bpmn:DataAssociation"))&&a&&!isCompensationAssociation(n,r))return[].concat([s],a.slice(1,-1),[u]);var g=isDirectionHorizontal(n,p)?PREFERRED_LAYOUTS_HORIZONTAL:PREFERRED_LAYOUTS_VERTICAL;return is(t,"bpmn:MessageFlow")?o=getMessageFlowManhattanOptions(n,r,g):(is(t,"bpmn:SequenceFlow")||isCompensationAssociation(n,r))&&(o=n===r?{preferredLayouts:getLoopPreferredLayout(n,t,g)}:is(n,"bpmn:BoundaryEvent")?{preferredLayouts:getBoundaryEventPreferredLayouts(n,r,u,g)}:isExpandedSubProcess(n)||isExpandedSubProcess(r)?{preferredLayouts:g.subProcess,preserveDocking:getSubProcessPreserveDocking(n)}:is(n,"bpmn:Gateway")?{preferredLayouts:g.fromGateway}:is(r,"bpmn:Gateway")?{preferredLayouts:g.toGateway}:{preferredLayouts:g.default}),o&&(o=assign(o,e),i=withoutRedundantPoints(repairConnection(n,r,s,u,a,o))),i||[s,u]},BpmnLayouter.$inject=["elementRegistry"];