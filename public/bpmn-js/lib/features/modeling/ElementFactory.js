import{assign,forEach,has,isDefined,isObject,omit}from"min-dash";import inherits from"inherits-browser";import{getBusinessObject,getDi,is}from"../../util/ModelUtil";import{isAny}from"../modeling/util/ModelingUtil";import{isExpanded}from"../../util/DiUtil";import BaseElementFactory from"diagram-js/lib/core/ElementFactory";import{DEFAULT_LABEL_SIZE}from"../../util/LabelUtil";import{ensureCompatDiRef}from"../../util/CompatibilityUtil";export default function ElementFactory(e,t){BaseElementFactory.call(this),this._bpmnFactory=e,this._moddle=t}function applyAttributes(e,t,i){return forEach(i,(function(i){t=applyAttribute(e,t,i)})),t}function applyAttribute(e,t,i){return void 0===t[i]?t:(e[i]=t[i],omit(t,[i]))}function isModdleDi(e){return isAny(e,["bpmndi:BPMNShape","bpmndi:BPMNEdge","bpmndi:BPMNDiagram","bpmndi:BPMNPlane"])}inherits(ElementFactory,BaseElementFactory),ElementFactory.$inject=["bpmnFactory","moddle"],ElementFactory.prototype._baseCreate=BaseElementFactory.prototype.create,ElementFactory.prototype.create=function(e,t){if("label"===e){var i=t.di||this._bpmnFactory.createDiLabel();return this._baseCreate(e,assign({type:"label",di:i},DEFAULT_LABEL_SIZE,t))}return this.createElement(e,t)},ElementFactory.prototype.createElement=function(e,t){var i,n,r,a=(t=assign({},t||{})).businessObject,s=t.di;if(!a){if(!t.type)throw new Error("no shape type specified");a=this._bpmnFactory.create(t.type),ensureCompatDiRef(a)}if(!isModdleDi(s)){var o=assign({},s||{},{id:a.id+"_di"});s="root"===e?this._bpmnFactory.createDiPlane(a,o):"connection"===e?this._bpmnFactory.createDiEdge(a,o):this._bpmnFactory.createDiShape(a,o)}return is(a,"bpmn:Group")&&(t=assign({isFrame:!0},t)),(t=applyAttributes(a,t,["processRef","isInterrupting","associationDirection","isForCompensation"])).isExpanded&&(t=applyAttribute(s,t,"isExpanded")),isAny(a,["bpmn:Lane","bpmn:Participant"])&&(t=applyAttribute(s,t,"isHorizontal")),is(a,"bpmn:SubProcess")&&(t.collapsed=!isExpanded(a,s)),is(a,"bpmn:ExclusiveGateway")&&(has(s,"isMarkerVisible")?void 0===s.isMarkerVisible&&(s.isMarkerVisible=!1):s.isMarkerVisible=!0),isDefined(t.triggeredByEvent)&&(a.triggeredByEvent=t.triggeredByEvent,delete t.triggeredByEvent),isDefined(t.cancelActivity)&&(a.cancelActivity=t.cancelActivity,delete t.cancelActivity),t.eventDefinitionType&&(n=a.get("eventDefinitions")||[],r=this._bpmnFactory.create(t.eventDefinitionType,t.eventDefinitionAttrs),"bpmn:ConditionalEventDefinition"===t.eventDefinitionType&&(r.condition=this._bpmnFactory.create("bpmn:FormalExpression")),n.push(r),r.$parent=a,a.eventDefinitions=n,delete t.eventDefinitionType),i=this.getDefaultSize(a,s),t=assign({id:a.id},i,t,{businessObject:a,di:s}),this._baseCreate(e,t)},ElementFactory.prototype.getDefaultSize=function(e,t){var i=getBusinessObject(e);if(t=t||getDi(e),is(i,"bpmn:SubProcess"))return isExpanded(i,t)?{width:350,height:200}:{width:100,height:80};if(is(i,"bpmn:Task"))return{width:100,height:80};if(is(i,"bpmn:Gateway"))return{width:50,height:50};if(is(i,"bpmn:Event"))return{width:36,height:36};if(is(i,"bpmn:Participant")){var n=void 0===t.isHorizontal||!0===t.isHorizontal;return isExpanded(i,t)?n?{width:600,height:250}:{width:250,height:600}:n?{width:400,height:60}:{width:60,height:400}}return is(i,"bpmn:Lane")?{width:400,height:100}:is(i,"bpmn:DataObjectReference")?{width:36,height:50}:is(i,"bpmn:DataStoreReference")?{width:50,height:50}:is(i,"bpmn:TextAnnotation")?{width:100,height:30}:is(i,"bpmn:Group")?{width:300,height:300}:{width:100,height:80}},ElementFactory.prototype.createParticipantShape=function(e){return isObject(e)||(e={isExpanded:e}),!1!==(e=assign({type:"bpmn:Participant"},e||{})).isExpanded&&(e.processRef=this._bpmnFactory.create("bpmn:Process")),this.createShape(e)};