import{assign,forEach}from"min-dash";import inherits from"inherits-browser";import{add as collectionAdd,remove as collectionRemove}from"diagram-js/lib/util/Collections";import{getBusinessObject,getDi,is}from"../../util/ModelUtil";import{isAny}from"./util/ModelingUtil";import{getLabel,isLabel,isLabelExternal}from"../../util/LabelUtil";import{isPlane}from"../../util/DrilldownUtil";import{delta}from"diagram-js/lib/util/PositionUtil";import CommandInterceptor from"diagram-js/lib/command/CommandInterceptor";export default function BpmnUpdater(e,t,n){CommandInterceptor.call(this,e),this._bpmnFactory=t;var o=this;function i(e){var t=e.context.oldRoot.children;forEach(t,(function(e){is(e,"bpmn:BaseElement")&&o.updateParent(e)}))}function a(e){var t=e.context.shape;is(t,"bpmn:BaseElement")&&o.updateBounds(t)}function s(e){o.updateConnection(e.context)}function c(e){o.updateConnectionWaypoints(e.context.connection)}function p(e){o.updateAttachment(e.context)}function r(e){const{element:n}=e.context,o=getLabel(n),i=getDi(n),a=i&&i.get("label");isLabelExternal(n)||isPlane(n)||(o&&!a?i.set("label",t.create("bpmndi:BPMNLabel")):!o&&a&&i.set("label",void 0))}this.executed(["connection.layout","connection.create"],(function(e){var t,o=e.context,i=o.hints||{};o.cropped||!1===i.createElementsBehavior||((t=o.connection).waypoints=n.getCroppedWaypoints(t),o.cropped=!0)})),this.reverted(["connection.layout"],(function(e){delete e.context.cropped})),this.executed(["shape.move","shape.create","shape.delete","connection.create","connection.move","connection.delete"],ifBpmn((function(e){var t=e.context;o.updateParent(t.shape||t.connection,t.oldParent)}))),this.reverted(["shape.move","shape.create","shape.delete","connection.create","connection.move","connection.delete"],ifBpmn((function(e){var t=e.context,n=t.shape||t.connection,i=t.parent||t.newParent;o.updateParent(n,i)}))),this.executed(["canvas.updateRoot"],i),this.reverted(["canvas.updateRoot"],i),this.executed(["shape.move","shape.create","shape.resize"],ifBpmn((function(e){"label"!==e.context.shape.type&&a(e)}))),this.reverted(["shape.move","shape.create","shape.resize"],ifBpmn((function(e){"label"!==e.context.shape.type&&a(e)}))),e.on("shape.changed",(function(e){"label"===e.element.type&&a({context:{shape:e.element}})})),this.executed(["connection.create","connection.move","connection.delete","connection.reconnect"],ifBpmn(s)),this.reverted(["connection.create","connection.move","connection.delete","connection.reconnect"],ifBpmn(s)),this.executed(["connection.layout","connection.move","connection.updateWaypoints"],ifBpmn(c)),this.reverted(["connection.layout","connection.move","connection.updateWaypoints"],ifBpmn(c)),this.executed("connection.reconnect",ifBpmn((function(e){var t=e.context,n=t.connection,o=t.oldSource,i=t.newSource,a=getBusinessObject(n),s=getBusinessObject(o),c=getBusinessObject(i);a.conditionExpression&&!isAny(c,["bpmn:Activity","bpmn:ExclusiveGateway","bpmn:InclusiveGateway"])&&(t.oldConditionExpression=a.conditionExpression,delete a.conditionExpression),o!==i&&s.default===a&&(t.oldDefault=s.default,delete s.default)}))),this.reverted("connection.reconnect",ifBpmn((function(e){var t=e.context,n=t.connection,o=t.oldSource,i=t.newSource,a=getBusinessObject(n),s=getBusinessObject(o),c=getBusinessObject(i);t.oldConditionExpression&&(a.conditionExpression=t.oldConditionExpression),t.oldDefault&&(s.default=t.oldDefault,delete c.default)}))),this.executed(["element.updateAttachment"],ifBpmn(p)),this.reverted(["element.updateAttachment"],ifBpmn(p)),this.executed("element.updateLabel",ifBpmn(r)),this.reverted("element.updateLabel",ifBpmn(r))}function getDefinitions(e){for(;e&&!is(e,"bpmn:Definitions");)e=e.$parent;return e}function ifBpmn(e){return function(t){var n=t.context,o=n.shape||n.connection||n.element;is(o,"bpmn:BaseElement")&&e(t)}}function getEmbeddedLabelBounds(e){if(is(e,"bpmn:Activity")){var t=getDi(e);if(t){var n=t.get("label");if(n)return n.get("bounds")}}}inherits(BpmnUpdater,CommandInterceptor),BpmnUpdater.$inject=["eventBus","bpmnFactory","connectionDocking"],BpmnUpdater.prototype.updateAttachment=function(e){var t=e.shape,n=t.businessObject,o=t.host;n.attachedToRef=o&&o.businessObject},BpmnUpdater.prototype.updateParent=function(e,t){if(!(isLabel(e)||is(e,"bpmn:DataStoreReference")&&e.parent&&is(e.parent,"bpmn:Collaboration"))){var n=e.parent,o=e.businessObject,i=getDi(e),a=n&&n.businessObject,s=getDi(n);is(e,"bpmn:FlowNode")&&this.updateFlowNodeRefs(o,a,t&&t.businessObject),is(e,"bpmn:DataOutputAssociation")&&(a=e.source?e.source.businessObject:null),is(e,"bpmn:DataInputAssociation")&&(a=e.target?e.target.businessObject:null),this.updateSemanticParent(o,a),is(e,"bpmn:DataObjectReference")&&o.dataObjectRef&&this.updateSemanticParent(o.dataObjectRef,a),this.updateDiParent(i,s)}},BpmnUpdater.prototype.updateBounds=function(e){var t=getDi(e),n=getEmbeddedLabelBounds(e);if(n){var o=delta(n,t.get("bounds"));assign(n,{x:e.x+o.x,y:e.y+o.y})}var i=isLabel(e)?this._getLabel(t):t,a=i.bounds;a||(a=this._bpmnFactory.createDiBounds(),i.set("bounds",a)),assign(a,{x:e.x,y:e.y,width:e.width,height:e.height})},BpmnUpdater.prototype.updateFlowNodeRefs=function(e,t,n){var o,i;n!==t&&(is(n,"bpmn:Lane")&&(o=n.get("flowNodeRef"),collectionRemove(o,e)),is(t,"bpmn:Lane")&&(i=t.get("flowNodeRef"),collectionAdd(i,e)))},BpmnUpdater.prototype.updateDiConnection=function(e,t,n){var o=getDi(e),i=getDi(t),a=getDi(n);o.sourceElement&&o.sourceElement.bpmnElement!==getBusinessObject(t)&&(o.sourceElement=t&&i),o.targetElement&&o.targetElement.bpmnElement!==getBusinessObject(n)&&(o.targetElement=n&&a)},BpmnUpdater.prototype.updateDiParent=function(e,t){if(t&&!is(t,"bpmndi:BPMNPlane")&&(t=t.$parent),e.$parent!==t){var n=(t||e.$parent).get("planeElement");t?(n.push(e),e.$parent=t):(collectionRemove(n,e),e.$parent=null)}},BpmnUpdater.prototype.getLaneSet=function(e){var t,n;return is(e,"bpmn:Lane")?((t=e.childLaneSet)||(t=this._bpmnFactory.create("bpmn:LaneSet"),e.childLaneSet=t,t.$parent=e),t):(is(e,"bpmn:Participant")&&(e=e.processRef),(t=(n=e.get("laneSets"))[0])||((t=this._bpmnFactory.create("bpmn:LaneSet")).$parent=e,n.push(t)),t)},BpmnUpdater.prototype.updateSemanticParent=function(e,t,n){var o;if(e.$parent!==t&&(!is(e,"bpmn:DataInput")&&!is(e,"bpmn:DataOutput")||(is(t,"bpmn:Participant")&&"processRef"in t&&(t=t.processRef),!("ioSpecification"in t)||t.ioSpecification!==e.$parent))){if(is(e,"bpmn:Lane"))t&&(t=this.getLaneSet(t)),o="lanes";else if(is(e,"bpmn:FlowElement")){if(t)if(is(t,"bpmn:Participant"))t=t.processRef;else if(is(t,"bpmn:Lane"))do{t=t.$parent.$parent}while(is(t,"bpmn:Lane"));o="flowElements"}else if(is(e,"bpmn:Artifact")){for(;t&&!is(t,"bpmn:Process")&&!is(t,"bpmn:SubProcess")&&!is(t,"bpmn:Collaboration");){if(is(t,"bpmn:Participant")){t=t.processRef;break}t=t.$parent}o="artifacts"}else if(is(e,"bpmn:MessageFlow"))o="messageFlows";else if(is(e,"bpmn:Participant")){o="participants";var i,a=e.processRef;a&&(i=getDefinitions(e.$parent||t),e.$parent&&(collectionRemove(i.get("rootElements"),a),a.$parent=null),t&&(collectionAdd(i.get("rootElements"),a),a.$parent=i))}else is(e,"bpmn:DataOutputAssociation")?o="dataOutputAssociations":is(e,"bpmn:DataInputAssociation")&&(o="dataInputAssociations");if(!o)throw new Error(`no parent for <${e.id}> in <${t.id}>`);var s;if(e.$parent&&(s=e.$parent.get(o),collectionRemove(s,e)),t?((s=t.get(o)).push(e),e.$parent=t):e.$parent=null,n){var c=n.get(o);collectionRemove(s,e),t&&(c||(c=[],t.set(o,c)),c.push(e))}}},BpmnUpdater.prototype.updateConnectionWaypoints=function(e){getDi(e).set("waypoint",this._bpmnFactory.createDiWaypoints(e.waypoints))},BpmnUpdater.prototype.updateConnection=function(e){var t,n=e.connection,o=getBusinessObject(n),i=n.source,a=getBusinessObject(i),s=n.target,c=getBusinessObject(n.target);if(is(o,"bpmn:DataAssociation"))is(o,"bpmn:DataInputAssociation")?(o.get("sourceRef")[0]=a,t=e.parent||e.newParent||c,this.updateSemanticParent(o,c,t)):is(o,"bpmn:DataOutputAssociation")&&(t=e.parent||e.newParent||a,this.updateSemanticParent(o,a,t),o.targetRef=c);else{var p=is(o,"bpmn:SequenceFlow");o.sourceRef!==a&&(p&&(collectionRemove(o.sourceRef&&o.sourceRef.get("outgoing"),o),a&&a.get("outgoing")&&a.get("outgoing").push(o)),o.sourceRef=a),o.targetRef!==c&&(p&&(collectionRemove(o.targetRef&&o.targetRef.get("incoming"),o),c&&c.get("incoming")&&c.get("incoming").push(o)),o.targetRef=c)}this.updateConnectionWaypoints(n),this.updateDiConnection(n,i,s)},BpmnUpdater.prototype._getLabel=function(e){return e.label||(e.label=this._bpmnFactory.createDiLabel()),e.label};