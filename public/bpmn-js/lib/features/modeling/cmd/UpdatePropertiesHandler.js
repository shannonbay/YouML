import{reduce,keys,forEach,assign}from"min-dash";import{getBusinessObject,getDi}from"../../../util/ModelUtil";var DEFAULT_FLOW="default",ID="id",DI="di",NULL_DIMENSIONS={width:0,height:0};export default function UpdatePropertiesHandler(e,t,r,i){this._elementRegistry=e,this._moddle=t,this._modeling=r,this._textRenderer=i}function isIdChange(e,t){return ID in e&&e[ID]!==t[ID]}function getProperties(e,t){var r=keys(t),i=e.businessObject,s=getDi(e);return reduce(r,(function(e,r){return e[r]=r!==DI?i.get(r):getDiProperties(s,keys(t.di)),e}),{})}function getDiProperties(e,t){return reduce(t,(function(t,r){return t[r]=e&&e.get(r),t}),{})}function setProperties(e,t){var r=e.businessObject,i=getDi(e);forEach(t,(function(e,t){t!==DI?r.set(t,e):i&&setDiProperties(i,e)}))}function setDiProperties(e,t){forEach(t,(function(t,r){e.set(r,t)}))}UpdatePropertiesHandler.$inject=["elementRegistry","moddle","modeling","textRenderer"],UpdatePropertiesHandler.prototype.execute=function(e){var t=e.element,r=[t];if(!t)throw new Error("element required");var i=this._elementRegistry,s=this._moddle.ids,n=t.businessObject,o=unwrapBusinessObjects(e.properties),d=e.oldProperties||getProperties(t,o);return isIdChange(o,n)&&(s.unclaim(n[ID]),i.updateId(t,o[ID]),s.claim(o[ID],n)),DEFAULT_FLOW in o&&(o[DEFAULT_FLOW]&&r.push(i.get(o[DEFAULT_FLOW].id)),n[DEFAULT_FLOW]&&r.push(i.get(n[DEFAULT_FLOW].id))),setProperties(t,o),e.oldProperties=d,e.changed=r,r},UpdatePropertiesHandler.prototype.postExecute=function(e){var t=e.element.label,r=t&&getBusinessObject(t).name;if(r){var i=this._textRenderer.getExternalLabelBounds(t,r);this._modeling.resizeShape(t,i,NULL_DIMENSIONS)}},UpdatePropertiesHandler.prototype.revert=function(e){var t=e.element,r=e.properties,i=e.oldProperties,s=t.businessObject,n=this._elementRegistry,o=this._moddle.ids;return setProperties(t,i),isIdChange(r,s)&&(o.unclaim(r[ID]),n.updateId(t,i[ID]),o.claim(i[ID],s)),e.changed};var referencePropertyNames=["default"];function unwrapBusinessObjects(e){var t=assign({},e);return referencePropertyNames.forEach((function(r){r in e&&(t[r]=getBusinessObject(t[r]))})),t}