import{collectLanes,getLanesRoot}from"../util/LaneUtil";import{is}from"../../../util/ModelUtil";import{add as collectionAdd,remove as collectionRemove}from"diagram-js/lib/util/Collections";import{asTRBL}from"diagram-js/lib/layout/LayoutUtil";var FLOW_NODE_REFS_ATTR="flowNodeRef",LANES_ATTR="lanes";export default function UpdateFlowNodeRefsHandler(e){this._elementRegistry=e}UpdateFlowNodeRefsHandler.$inject=["elementRegistry"],UpdateFlowNodeRefsHandler.prototype._computeUpdates=function(e,o){var t=[],n=[],r={},i=[];function a(e){-1===t.indexOf(e)&&(i.push(e),t.push(e))}return o.forEach((function(e){var o=getLanesRoot(e);o&&-1===t.indexOf(o)&&(o.children.filter((function(e){return is(e,"bpmn:FlowNode")})).forEach(a),t.push(o))})),e.forEach(a),i.forEach((function(e){var o=e.businessObject,t=o.get(LANES_ATTR).slice(),i=function(e){if(!e.parent)return[];var o=function(e){var o=getLanesRoot(e);return r[o.id]||(r[o.id]=collectLanes(o)),r[o.id]}(e);return o.filter((function(o){return t=e,n=asTRBL(o),r=t.x+t.width/2,i=t.y+t.height/2,r>n.left&&r<n.right&&i>n.top&&i<n.bottom;var t,n,r,i})).map((function(e){return e.businessObject}))}(e);n.push({flowNode:o,remove:t,add:i})})),o.forEach((function(e){var o=e.businessObject;e.parent||o.get(FLOW_NODE_REFS_ATTR).forEach((function(e){n.push({flowNode:e,remove:[o],add:[]})}))})),n},UpdateFlowNodeRefsHandler.prototype.execute=function(e){var o=e.updates;return o||(o=e.updates=this._computeUpdates(e.flowNodeShapes,e.laneShapes)),o.forEach((function(e){var o=e.flowNode,t=o.get(LANES_ATTR);e.remove.forEach((function(e){collectionRemove(t,e),collectionRemove(e.get(FLOW_NODE_REFS_ATTR),o)})),e.add.forEach((function(e){collectionAdd(t,e),collectionAdd(e.get(FLOW_NODE_REFS_ATTR),o)}))})),[]},UpdateFlowNodeRefsHandler.prototype.revert=function(e){return e.updates.forEach((function(e){var o=e.flowNode,t=o.get(LANES_ATTR);e.add.forEach((function(e){collectionRemove(t,e),collectionRemove(e.get(FLOW_NODE_REFS_ATTR),o)})),e.remove.forEach((function(e){collectionAdd(t,e),collectionAdd(e.get(FLOW_NODE_REFS_ATTR),o)}))})),[]};