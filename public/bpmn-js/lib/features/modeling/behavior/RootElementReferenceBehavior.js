import inherits from"inherits-browser";import{find,isArray,matchPattern,some}from"min-dash";import CommandInterceptor from"diagram-js/lib/command/CommandInterceptor";import{add as collectionAdd,remove as collectionRemove}from"diagram-js/lib/util/Collections";import{getBusinessObject,is}from"../../../util/ModelUtil";import{isAny}from"../util/ModelingUtil";import{hasEventDefinition}from"../../../util/DiUtil";var LOW_PRIORITY=500;export default function RootElementReferenceBehavior(e,n,t,i,o){function r(e){return isAny(e,["bpmn:ReceiveTask","bpmn:SendTask"])||hasAnyEventDefinition(e,["bpmn:ErrorEventDefinition","bpmn:EscalationEventDefinition","bpmn:MessageEventDefinition","bpmn:SignalEventDefinition"])}function s(n){var t=e.getDefinitions().get("rootElements");return!!find(t,matchPattern({id:n.id}))}function a(e){return is(e,"bpmn:ErrorEventDefinition")?"errorRef":is(e,"bpmn:EscalationEventDefinition")?"escalationRef":is(e,"bpmn:MessageEventDefinition")?"messageRef":is(e,"bpmn:SignalEventDefinition")?"signalRef":void 0}function m(e){if(isAny(e,["bpmn:ReceiveTask","bpmn:SendTask"]))return e.get("messageRef");var n=e.get("eventDefinitions")[0];return n.get(a(n))}t.invoke(CommandInterceptor,this),this.executed(["shape.create","element.updateProperties","element.updateModdleProperties"],(function(n){var t=n.shape||n.element;if(r(t)){var i,o=m(getBusinessObject(t));o&&!s(o)&&(i=e.getDefinitions().get("rootElements"),collectionAdd(i,o),n.addedRootElement=o)}}),!0),this.reverted(["shape.create","element.updateProperties","element.updateModdleProperties"],(function(n){var t=n.addedRootElement;if(t){var i=e.getDefinitions().get("rootElements");collectionRemove(i,t)}}),!0),n.on("copyPaste.copyElement",(function(e){var n=e.descriptor,t=e.element;if(!t.labelTarget&&r(t)){var i=m(getBusinessObject(t));i&&(n.referencedRootElement=i)}})),n.on("copyPaste.pasteElement",LOW_PRIORITY,(function(e){var n=e.descriptor,t=n.businessObject,r=n.referencedRootElement;r&&(s(r)||(r=i.copyElement(r,o.create(r.$type))),function(e,n){if(isAny(e,["bpmn:ReceiveTask","bpmn:SendTask"]))return e.set("messageRef",n);var t=e.get("eventDefinitions")[0];t.set(a(t),n)}(t,r),delete n.referencedRootElement)}))}function hasAnyEventDefinition(e,n){return isArray(n)||(n=[n]),some(n,(function(n){return hasEventDefinition(e,n)}))}RootElementReferenceBehavior.$inject=["bpmnjs","eventBus","injector","moddleCopy","bpmnFactory"],inherits(RootElementReferenceBehavior,CommandInterceptor);