import{assign}from"min-dash";import inherits from"inherits-browser";import{is,getBusinessObject}from"../../../util/ModelUtil";import{isLabelExternal,getLabel,hasExternalLabel,isLabel}from"../../../util/LabelUtil";import{getLabelAdjustment}from"./util/LabelLayoutUtil";import CommandInterceptor from"diagram-js/lib/command/CommandInterceptor";import{getNewAttachPoint}from"diagram-js/lib/util/AttachUtil";import{getMid,roundPoint}from"diagram-js/lib/layout/LayoutUtil";import{delta}from"diagram-js/lib/util/PositionUtil";import{sortBy}from"min-dash";import{getDistancePointLine,perpendicularFoot}from"./util/GeometricUtil";var NAME_PROPERTY="name",TEXT_PROPERTY="text";export default function LabelBehavior(e,t,n,i){function a(e){var n=e.context,a=n.element,o=n.properties;if(NAME_PROPERTY in o&&t.updateLabel(a,o[NAME_PROPERTY]),TEXT_PROPERTY in o&&is(a,"bpmn:TextAnnotation")){var r=i.getTextAnnotationBounds({x:a.x,y:a.y,width:a.width,height:a.height},o[TEXT_PROPERTY]||"");t.updateLabel(a,o.text,r)}}CommandInterceptor.call(this,e),this.postExecute("element.updateProperties",a),this.postExecute("element.updateModdleProperties",(e=>{getBusinessObject(e.context.element)===e.context.moddleElement&&a(e)})),this.postExecute(["shape.create","connection.create"],(function(e){var n=e.context;if(!1!==(n.hints||{}).createElementsBehavior){var i=n.shape||n.connection;!isLabel(i)&&isLabelExternal(i)&&getLabel(i)&&t.updateLabel(i,getLabel(i))}})),this.postExecute("shape.delete",(function(e){var n=e.context,i=n.labelTarget,a=n.hints||{};i&&!1!==a.unsetLabel&&t.updateLabel(i,null,null,{removeShape:!1})})),this.postExecute(["connection.layout","connection.updateWaypoints"],(function(e){var n=e.context;if(!1!==(n.hints||{}).labelBehavior){var i,a=n.connection.label;a&&a.parent&&(i=function(e){var t=e.context,n=t.connection,i=n.label,a=assign({},t.hints),o=t.newWaypoints||n.waypoints,r=t.oldWaypoints;return void 0===a.startChanged&&(a.startChanged=!!a.connectionStart),void 0===a.endChanged&&(a.endChanged=!!a.connectionEnd),getLabelAdjustment(i,o,r,a)}(e),t.moveShape(a,i))}})),this.postExecute(["shape.replace"],(function(e){var t=e.context,n=t.newShape,i=t.oldShape,a=getBusinessObject(n);a&&isLabelExternal(a)&&i.label&&n.label&&(n.label.x=i.label.x,n.label.y=i.label.y)})),this.postExecute("shape.resize",(function(e){var n=e.context,i=n.shape,a=n.newBounds,o=n.oldBounds;if(hasExternalLabel(i)){var r=i.label,l=getReferencePointDelta(getReferencePoint(getMid(r),asEdges(o)),o,a);t.moveShape(r,l)}}))}inherits(LabelBehavior,CommandInterceptor),LabelBehavior.$inject=["eventBus","modeling","bpmnFactory","textRenderer"];export function getReferencePointDelta(e,t,n){var i=getNewAttachPoint(e,t,n);return roundPoint(delta(i,e))}export function getReferencePoint(e,t){if(t.length){var n=getNearestLine(e,t);return perpendicularFoot(e,n)}}export function asEdges(e){return[[{x:e.x,y:e.y},{x:e.x+(e.width||0),y:e.y}],[{x:e.x+(e.width||0),y:e.y},{x:e.x+(e.width||0),y:e.y+(e.height||0)}],[{x:e.x,y:e.y+(e.height||0)},{x:e.x+(e.width||0),y:e.y+(e.height||0)}],[{x:e.x,y:e.y},{x:e.x,y:e.y+(e.height||0)}]]}function getNearestLine(e,t){var n=t.map((function(t){return{line:t,distance:getDistancePointLine(e,t)}}));return sortBy(n,"distance")[0].line}