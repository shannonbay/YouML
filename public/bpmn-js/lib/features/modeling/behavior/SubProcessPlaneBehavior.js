import inherits from"inherits-browser";import CommandInterceptor from"diagram-js/lib/command/CommandInterceptor";import{find}from"min-dash";import{isExpanded}from"../../../util/DiUtil";import{getBusinessObject,getDi,is}from"../../../util/ModelUtil";import{getMid}from"diagram-js/lib/layout/LayoutUtil";import{getBBox}from"diagram-js/lib/util/Elements";import{getPlaneIdFromShape,getShapeIdFromPlane,isPlane,toPlaneId}from"../../../util/DrilldownUtil";var LOW_PRIORITY=400,HIGH_PRIORITY=600,DEFAULT_POSITION={x:180,y:160};export default function SubProcessPlaneBehavior(e,t,n,i,r,a,o){CommandInterceptor.call(this,t),this._canvas=e,this._eventBus=t,this._modeling=n,this._elementFactory=i,this._bpmnFactory=r,this._bpmnjs=a,this._elementRegistry=o;var s=this;function l(e){return is(e,"bpmn:SubProcess")&&!isExpanded(e)}function d(t){var n=t.shape,i=t.newRootElement,r=getBusinessObject(n);i=s._addDiagram(i||r),t.newRootElement=e.addRootElement(i)}function p(t){var n=t.shape,i=getBusinessObject(n);s._removeDiagram(i);var r=t.newRootElement=o.get(getPlaneIdFromShape(i));e.removeRootElement(r)}this.executed("shape.create",(function(e){l(e.shape)&&d(e)}),!0),this.postExecuted("shape.create",(function(e){var t=e.shape,n=e.newRootElement;n&&t.children&&(s._showRecursively(t.children),s._moveChildrenToShape(t,n))}),!0),this.reverted("shape.create",(function(e){l(e.shape)&&p(e)}),!0),this.preExecuted("shape.delete",(function(e){var t=e.shape;if(l(t)){var i=o.get(getPlaneIdFromShape(t));i&&n.removeElements(i.children.slice())}}),!0),this.executed("shape.delete",(function(e){l(e.shape)&&p(e)}),!0),this.reverted("shape.delete",(function(e){l(e.shape)&&d(e)}),!0),this.preExecuted("shape.replace",(function(t){var n=t.oldShape,i=t.newShape;l(n)&&l(i)&&(t.oldRoot=e.removeRootElement(getPlaneIdFromShape(n)))}),!0),this.postExecuted("shape.replace",(function(t){var i=t.newShape,r=t.oldRoot,a=e.findRoot(getPlaneIdFromShape(i));if(r&&a){var o=r.children;n.moveElements(o,{x:0,y:0},a)}}),!0),this.executed("element.updateProperties",(function(e){var t=e.element;if(is(t,"bpmn:SubProcess")){var n=e.properties,i=e.oldProperties.id,r=n.id;if(i!==r){if(isPlane(t))return o.updateId(t,toPlaneId(r)),void o.updateId(i,r);o.get(toPlaneId(i))&&o.updateId(toPlaneId(i),toPlaneId(r))}}}),!0),this.reverted("element.updateProperties",(function(e){var t=e.element;if(is(t,"bpmn:SubProcess")){var n=e.properties,i=e.oldProperties.id,r=n.id;if(i!==r){if(isPlane(t))return o.updateId(t,toPlaneId(i)),void o.updateId(r,i);var a=o.get(toPlaneId(r));a&&o.updateId(a,toPlaneId(i))}}}),!0),t.on("element.changed",(function(e){var n=e.element;if(isPlane(n)){var i=n,r=o.get(getShapeIdFromPlane(i));r&&r!==i&&t.fire("element.changed",{element:r})}})),this.executed("shape.toggleCollapse",LOW_PRIORITY,(function(e){var t=e.shape;is(t,"bpmn:SubProcess")&&(isExpanded(t)?p(e):(d(e),s._showRecursively(t.children)))}),!0),this.reverted("shape.toggleCollapse",LOW_PRIORITY,(function(e){var t=e.shape;is(t,"bpmn:SubProcess")&&(isExpanded(t)?p(e):(d(e),s._showRecursively(t.children)))}),!0),this.postExecuted("shape.toggleCollapse",HIGH_PRIORITY,(function(e){var t=e.shape;if(is(t,"bpmn:SubProcess")){var n=e.newRootElement;n&&(isExpanded(t)?s._moveChildrenToShape(n,t):s._moveChildrenToShape(t,n))}}),!0),t.on("copyPaste.createTree",(function(e){var t=e.element,n=e.children;if(l(t)){var i=getPlaneIdFromShape(t),r=o.get(i);r&&n.push.apply(n,r.children)}})),t.on("copyPaste.copyElement",(function(e){var t=e.descriptor,n=e.element,i=e.elements,r=n.parent;if(is(getDi(r),"bpmndi:BPMNPlane")){var a=getShapeIdFromPlane(r),o=find(i,(function(e){return e.id===a}));o&&(t.parent=o.id)}})),t.on("copyPaste.pasteElement",(function(e){var t=e.descriptor;t.parent&&(l(t.parent)||t.parent.hidden)&&(t.hidden=!0)}))}inherits(SubProcessPlaneBehavior,CommandInterceptor),SubProcessPlaneBehavior.prototype._moveChildrenToShape=function(e,t){var n,i=this._modeling,r=e.children;if(r){var a=(r=r.concat(r.reduce((function(t,n){return n.label&&n.label.parent!==e?t.concat(n.label):t}),[]))).filter((function(e){return!e.hidden}));if(a.length){var o=getBBox(a);if(t.x){var s=getMid(t),l=getMid(o);n={x:s.x-l.x,y:s.y-l.y}}else n={x:DEFAULT_POSITION.x-o.x,y:DEFAULT_POSITION.y-o.y};i.moveElements(r,n,t,{autoResize:!1})}else i.moveElements(r,{x:0,y:0},t,{autoResize:!1})}},SubProcessPlaneBehavior.prototype._showRecursively=function(e,t){var n=this,i=[];return e.forEach((function(e){e.hidden=!!t,i=i.concat(e),e.children&&(i=i.concat(n._showRecursively(e.children,e.collapsed||t)))})),i},SubProcessPlaneBehavior.prototype._addDiagram=function(e){var t=this._bpmnjs.getDefinitions().diagrams;return e.businessObject||(e=this._createNewDiagram(e)),t.push(e.di.$parent),e},SubProcessPlaneBehavior.prototype._createNewDiagram=function(e){var t=this._bpmnFactory,n=this._elementFactory,i=t.create("bpmndi:BPMNPlane",{bpmnElement:e}),r=t.create("bpmndi:BPMNDiagram",{plane:i});return i.$parent=r,n.createRoot({id:getPlaneIdFromShape(e),type:e.$type,di:i,businessObject:e,collapsed:!0})},SubProcessPlaneBehavior.prototype._removeDiagram=function(e){var t=this._bpmnjs.getDefinitions().diagrams,n=find(t,(function(t){return t.plane.bpmnElement.id===e.id}));return t.splice(t.indexOf(n),1),n},SubProcessPlaneBehavior.$inject=["canvas","eventBus","modeling","elementFactory","bpmnFactory","bpmnjs","elementRegistry"];