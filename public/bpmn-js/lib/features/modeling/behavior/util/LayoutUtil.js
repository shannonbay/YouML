import{getDistancePointPoint,rotateVector,getAngle}from"./GeometricUtil";import{getAttachment}from"./LineAttachmentUtil";import{roundPoint}from"diagram-js/lib/layout/LayoutUtil";export function findNewLineStartIndex(t,e,n,i){var o=n.segmentIndex,r=e.length-t.length;if(i.segmentMove){var a=i.segmentMove.segmentStartIndex,g=i.segmentMove.newSegmentStartIndex;return o===a?g:o>=g?o+r<g?g:o+r:o}if(i.bendpointMove){var l,d=i.bendpointMove.insert,x=i.bendpointMove.bendpointIndex;return 0===r?o:(o>=x&&(l=d?o+1:o-1),o<x&&(l=o,d&&"bendpoint"!==n.type&&x-1===o&&relativePositionMidWaypoint(e,x)<n.relativeLocation&&l++),l)}return 0===r?o:i.connectionStart&&0===o?0:i.connectionEnd&&o===t.length-2?e.length-2:Math.floor((e.length-2)/2)}export function getAnchorPointAdjustment(t,e,n,i){var o=0,r=0,a={point:t,delta:{x:0,y:0}},g=getAttachment(t,n),l=g.segmentIndex,d=findNewLineStartIndex(n,e,g,i);if(d<0||d>e.length-2||null===d)return a;var x=getLine(n,l),u=getLine(e,d),y=g.position,c=getRelativeFootPosition(x,y),p=getAngleDelta(x,u);if("bendpoint"===g.type){var v=e.length-n.length,s=g.bendpointIndex,f=n[s];if(-1!==e.indexOf(f))return a;if(0===v){var m=e[s];return{delta:{x:o=m.x-g.position.x,y:r=m.y-g.position.y},point:{x:t.x+o,y:t.y+r}}}v<0&&0!==s&&s<n.length-1&&(c=relativePositionMidWaypoint(n,s))}var P={x:(u[1].x-u[0].x)*c+u[0].x,y:(u[1].y-u[0].y)*c+u[0].y},h=rotateVector({x:t.x-y.x,y:t.y-y.y},p);return o=P.x+h.x-t.x,r=P.y+h.y-t.y,{point:roundPoint(P),delta:roundPoint({x:o,y:r})}}function relativePositionMidWaypoint(t,e){var n=getDistancePointPoint(t[e-1],t[e]);return n/(n+getDistancePointPoint(t[e],t[e+1]))}function getAngleDelta(t,e){var n=getAngle(t);return getAngle(e)-n}function getLine(t,e){return[t[e],t[e+1]]}function getRelativeFootPosition(t,e){var n=getDistancePointPoint(t[0],t[1]),i=getDistancePointPoint(t[0],e);return 0===n?0:i/n}