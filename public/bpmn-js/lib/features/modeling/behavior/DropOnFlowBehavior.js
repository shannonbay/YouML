import inherits from"inherits-browser";import{assign,filter,find,isNumber}from"min-dash";import{getMid}from"diagram-js/lib/layout/LayoutUtil";import CommandInterceptor from"diagram-js/lib/command/CommandInterceptor";import{getApproxIntersection}from"diagram-js/lib/util/LineIntersection";export default function DropOnFlowBehavior(e,t,n){function i(e,i,o){var r,a,s,c,p,l,m,u,d=i.waypoints,h=e.outgoing.slice(),g=e.incoming.slice();u=isNumber(o.width)?getMid(o):o;var f=getApproxIntersection(d,u);if(f){if(r=d.slice(0,f.index),a=d.slice(f.index+(f.bendpoint?1:0)),!r.length||!a.length)return;s=f.bendpoint?d[f.index]:u,1!==r.length&&isPointInsideBBox(e,r[r.length-1])||r.push(copy(s)),1!==a.length&&isPointInsideBBox(e,a[0])||a.unshift(copy(s))}c=i.source,p=i.target,t.canConnect(c,e,i)&&(n.reconnectEnd(i,e,r||u),l=i),t.canConnect(e,p,i)&&(l?m=n.connect(e,p,{type:i.type,waypoints:a}):(n.reconnectStart(i,e,a||u),m=i));var x=[].concat(l&&filter(g,(function(e){return e.source===l.source}))||[],m&&filter(h,(function(e){return e.target===m.target}))||[]);x.length&&n.removeElements(x)}CommandInterceptor.call(this,e),this.preExecute("elements.move",(function(e){var n=e.newParent,i=e.shapes,o=e.delta,r=i[0];if(r&&n){n&&n.waypoints&&(e.newParent=n=n.parent);var a=getMid(r),s={x:a.x+o.x,y:a.y+o.y},c=find(n.children,(function(e){return t.canInsert(i,e)&&getApproxIntersection(e.waypoints,s)}));c&&(e.targetFlow=c,e.position=s)}}),!0),this.postExecuted("elements.move",(function(e){var t=e.shapes,n=e.targetFlow,o=e.position;n&&i(t[0],n,o)}),!0),this.preExecute("shape.create",(function(e){var n=e.parent,i=e.shape;t.canInsert(i,n)&&(e.targetFlow=n,e.parent=n.parent)}),!0),this.postExecuted("shape.create",(function(e){var t=e.shape,n=e.targetFlow,o=e.position;n&&i(t,n,o)}),!0)}function isPointInsideBBox(e,t){var n=t.x,i=t.y;return n>=e.x&&n<=e.x+e.width&&i>=e.y&&i<=e.y+e.height}function copy(e){return assign({},e)}inherits(DropOnFlowBehavior,CommandInterceptor),DropOnFlowBehavior.$inject=["eventBus","bpmnRules","modeling"];