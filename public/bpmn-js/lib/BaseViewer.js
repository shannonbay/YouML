import{assign,find,isNumber,omit}from"min-dash";import{domify,assignStyle,query as domQuery,remove as domRemove}from"min-dom";import{innerSVG}from"tiny-svg";import Diagram from"diagram-js";import BpmnModdle from"bpmn-moddle";import inherits from"inherits-browser";import{importBpmnDiagram}from"./import/Importer";export default function BaseViewer(t){t=assign({},DEFAULT_OPTIONS,t),this._moddle=this._createModdle(t),this._container=this._createContainer(t),addProjectLogo(this._container),this._init(this._container,this._moddle,t)}function addWarningsToError(t,e){return t.warnings=e,t}function checkValidationError(t){const e=/unparsable content <([^>]+)> detected([\s\S]*)$/.exec(t.message);return e&&(t.message="unparsable content <"+e[1]+"> detected; this may indicate an invalid BPMN 2.0 diagram file"+e[2]),t}inherits(BaseViewer,Diagram),BaseViewer.prototype.importXML=async function(t,e){const i=this;let n=[];try{let r;t=this._emit("import.parse.start",{xml:t})||t;try{r=await this._moddle.fromXML(t,"bpmn:Definitions")}catch(t){throw this._emit("import.parse.complete",{error:t}),t}let s=r.rootElement;const a=r.references,d=r.warnings,c=r.elementsById;n=n.concat(d),s=this._emit("import.parse.complete",(o={error:null,definitions:s,elementsById:c,references:a,warnings:n},i.get("eventBus").createEvent(o)))||s;const m=await this.importDefinitions(s,e);return n=n.concat(m.warnings),this._emit("import.done",{error:null,warnings:n}),{warnings:n}}catch(t){let e=t;throw n=n.concat(e.warnings||[]),addWarningsToError(e,n),e=checkValidationError(e),this._emit("import.done",{error:e,warnings:e.warnings}),e}var o},BaseViewer.prototype.importDefinitions=async function(t,e){return this._setDefinitions(t),{warnings:(await this.open(e)).warnings}},BaseViewer.prototype.open=async function(t){const e=this._definitions;let i=t;if(!e){const t=new Error("no XML imported");throw addWarningsToError(t,[]),t}if("string"==typeof t&&(i=findBPMNDiagram(e,t),!i)){const e=new Error("BPMNDiagram <"+t+"> not found");throw addWarningsToError(e,[]),e}try{this.clear()}catch(t){throw addWarningsToError(t,[]),t}const{warnings:n}=await importBpmnDiagram(this,e,i);return{warnings:n}},BaseViewer.prototype.saveXML=async function(t){t=t||{};let e,i,n=this._definitions;try{if(!n)throw new Error("no definitions loaded");n=this._emit("saveXML.start",{definitions:n})||n,i=(await this._moddle.toXML(n,t)).xml,i=this._emit("saveXML.serialized",{xml:i})||i}catch(t){e=t}const o=e?{error:e}:{xml:i};if(this._emit("saveXML.done",o),e)throw e;return o},BaseViewer.prototype.saveSVG=async function(){let t,e;this._emit("saveSVG.start");try{const e=this.get("canvas"),i=e.getActiveLayer(),n=domQuery(":scope > defs",e._svg),o=innerSVG(i),r=n?"<defs>"+innerSVG(n)+"</defs>":"",s=i.getBBox();t='<?xml version="1.0" encoding="utf-8"?>\n\x3c!-- created with bpmn-js / http://bpmn.io --\x3e\n<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">\n<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="'+s.width+'" height="'+s.height+'" viewBox="'+s.x+" "+s.y+" "+s.width+" "+s.height+'" version="1.1">'+r+o+"</svg>"}catch(t){e=t}if(this._emit("saveSVG.done",{error:e,svg:t}),e)throw e;return{svg:t}},BaseViewer.prototype._setDefinitions=function(t){this._definitions=t},BaseViewer.prototype.getModules=function(){return this._modules},BaseViewer.prototype.clear=function(){this.getDefinitions()&&Diagram.prototype.clear.call(this)},BaseViewer.prototype.destroy=function(){Diagram.prototype.destroy.call(this),domRemove(this._container)},BaseViewer.prototype.on=function(t,e,i,n){return this.get("eventBus").on(t,e,i,n)},BaseViewer.prototype.off=function(t,e){this.get("eventBus").off(t,e)},BaseViewer.prototype.attachTo=function(t){if(!t)throw new Error("parentNode required");this.detach(),t.get&&t.constructor.prototype.jquery&&(t=t.get(0)),"string"==typeof t&&(t=domQuery(t)),t.appendChild(this._container),this._emit("attach",{}),this.get("canvas").resized()},BaseViewer.prototype.getDefinitions=function(){return this._definitions},BaseViewer.prototype.detach=function(){const t=this._container,e=t.parentNode;e&&(this._emit("detach",{}),e.removeChild(t))},BaseViewer.prototype._init=function(t,e,i){const n=i.modules||this.getModules(i),o=i.additionalModules||[],r=[].concat([{bpmnjs:["value",this],moddle:["value",e]}],n,o),s=assign(omit(i,["additionalModules"]),{canvas:assign({},i.canvas,{container:t}),modules:r});Diagram.call(this,s),i&&i.container&&this.attachTo(i.container)},BaseViewer.prototype._emit=function(t,e){return this.get("eventBus").fire(t,e)},BaseViewer.prototype._createContainer=function(t){const e=domify('<div class="bjs-container"></div>');return assignStyle(e,{width:ensureUnit(t.width),height:ensureUnit(t.height),position:t.position}),e},BaseViewer.prototype._createModdle=function(t){const e=assign({},this._moddleExtensions,t.moddleExtensions);return new BpmnModdle(e)},BaseViewer.prototype._modules=[];const DEFAULT_OPTIONS={width:"100%",height:"100%",position:"relative"};function ensureUnit(t){return t+(isNumber(t)?"px":"")}function findBPMNDiagram(t,e){return e&&find(t.diagrams,(function(t){return t.id===e}))||null}import{open as openPoweredBy,BPMNIO_IMG,LOGO_STYLES,LINK_STYLES}from"./util/PoweredByUtil";import{event as domEvent}from"min-dom";function addProjectLogo(t){const e=domify('<a href="http://bpmn.io" target="_blank" class="bjs-powered-by" title="Powered by bpmn.io" >'+BPMNIO_IMG+"</a>");assignStyle(domQuery("svg",e),LOGO_STYLES),assignStyle(e,LINK_STYLES,{position:"absolute",bottom:"15px",right:"15px",zIndex:"100"}),t.appendChild(e),domEvent.bind(e,"click",(function(t){openPoweredBy(),t.preventDefault()}))}