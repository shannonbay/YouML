import{find,forEach,map}from"min-dash";import BpmnTreeWalker from"./BpmnTreeWalker";import{is}from"../util/ModelUtil";export function importBpmnDiagram(n,r,e){var o,t,i,a=[];return new Promise((function(s,m){try{return o=n.get("bpmnImporter"),t=n.get("eventBus"),i=n.get("canvas"),t.fire("import.render.start",{definitions:r}),function(n,r){var e=new BpmnTreeWalker({root:function(n,r){return o.add(n,r)},element:function(n,r,e){return o.add(n,r,e)},error:function(n,r){a.push({message:n,context:r})}});r=r||n.diagrams&&n.diagrams[0];var t=getDiagramsToImport(n,r);if(!t)throw new Error("no diagram to display");forEach(t,(function(r){e.handleDefinitions(n,r)}));var s=r.plane.bpmnElement.id;i.setRootElement(i.findRoot(s+"_plane")||i.findRoot(s))}(r,e),t.fire("import.render.complete",{error:void 0,warnings:a}),s({warnings:a})}catch(n){return n.warnings=a,m(n)}}))}function getDiagramsToImport(n,r){if(r&&r.plane){var e,o=r.plane.bpmnElement,t=o;is(o,"bpmn:Process")||is(o,"bpmn:Collaboration")||(t=findRootProcess(o)),e=is(t,"bpmn:Collaboration")?t:find(n.rootElements,(function(n){if(is(n,"bpmn:Collaboration"))return find(n.participants,(function(n){return n.processRef===t}))}));var i=[t];e&&(i=map(e.participants,(function(n){return n.processRef}))).push(e);var a=selfAndAllFlowElements(i),s=[r],m=[o];return forEach(n.diagrams,(function(n){if(n.plane){var r=n.plane.bpmnElement;-1!==a.indexOf(r)&&-1===m.indexOf(r)&&(s.push(n),m.push(r))}})),s}}function selfAndAllFlowElements(n){var r=[];return forEach(n,(function(n){n&&(r.push(n),r=r.concat(selfAndAllFlowElements(n.flowElements)))})),r}function findRootProcess(n){for(var r=n;r;){if(is(r,"bpmn:Process"))return r;r=r.$parent}}