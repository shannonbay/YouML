import{assign}from"min-dash";import{is}from"../util/ModelUtil";import{isLabelExternal,getExternalLabelBounds,getLabel}from"../util/LabelUtil";import{getMid}from"diagram-js/lib/layout/LayoutUtil";import{isExpanded}from"../util/DiUtil";import{elementToString}from"./Util";function elementData(e,t,n){return assign({id:e.id,type:e.$type,businessObject:e,di:t},n)}function getWaypoints(e,t,n){var r=e.waypoint;return!r||r.length<2?[getMid(t),getMid(n)]:r.map((function(e){return{x:e.x,y:e.y}}))}function notYetDrawn(e,t,n){return new Error(`element ${elementToString(t)} referenced by ${elementToString(e)}#${n} not yet drawn`)}export default function BpmnImporter(e,t,n,r,i){this._eventBus=e,this._canvas=t,this._elementFactory=n,this._elementRegistry=r,this._textRenderer=i}function isPointInsideBBox(e,t){var n=t.x,r=t.y;return n>=e.x&&n<=e.x+e.width&&r>=e.y&&r<=e.y+e.height}function isFrameElement(e){return is(e,"bpmn:Group")}BpmnImporter.$inject=["eventBus","canvas","elementFactory","elementRegistry","textRenderer"],BpmnImporter.prototype.add=function(e,t,n){var r,i,a;if(is(t,"bpmndi:BPMNPlane")){var o=is(e,"bpmn:SubProcess")?{id:e.id+"_plane"}:{};r=this._elementFactory.createRoot(elementData(e,t,o)),this._canvas.addRootElement(r)}else if(is(t,"bpmndi:BPMNShape")){var s=!isExpanded(e,t),d=isFrameElement(e);i=n&&(n.hidden||n.collapsed);var m=t.bounds;r=this._elementFactory.createShape(elementData(e,t,{collapsed:s,hidden:i,x:Math.round(m.x),y:Math.round(m.y),width:Math.round(m.width),height:Math.round(m.height),isFrame:d})),is(e,"bpmn:BoundaryEvent")&&this._attachBoundary(e,r),is(e,"bpmn:Lane")&&(a=0),is(e,"bpmn:DataStoreReference")&&(isPointInsideBBox(n,getMid(m))||(n=this._canvas.findRoot(n))),this._canvas.addShape(r,n,a)}else{if(!is(t,"bpmndi:BPMNEdge"))throw new Error(`unknown di ${elementToString(t)} for element ${elementToString(e)}`);var l=this._getSource(e),p=this._getTarget(e);i=n&&(n.hidden||n.collapsed),r=this._elementFactory.createConnection(elementData(e,t,{hidden:i,source:l,target:p,waypoints:getWaypoints(t,l,p)})),is(e,"bpmn:DataAssociation")&&(n=this._canvas.findRoot(n)),this._canvas.addConnection(r,n,a)}return isLabelExternal(e)&&getLabel(r)&&this.addLabel(e,t,r),this._eventBus.fire("bpmnElement.added",{element:r}),r},BpmnImporter.prototype._attachBoundary=function(e,t){var n=e.attachedToRef;if(!n)throw new Error(`missing ${elementToString(e)}#attachedToRef`);var r=this._elementRegistry.get(n.id),i=r&&r.attachers;if(!r)throw notYetDrawn(e,n,"attachedToRef");t.host=r,i||(r.attachers=i=[]),-1===i.indexOf(t)&&i.push(t)},BpmnImporter.prototype.addLabel=function(e,t,n){var r,i,a;return r=getExternalLabelBounds(t,n),(i=getLabel(n))&&(r=this._textRenderer.getExternalLabelBounds(r,i)),a=this._elementFactory.createLabel(elementData(e,t,{id:e.id+"_label",labelTarget:n,type:"label",hidden:n.hidden||!getLabel(n),x:Math.round(r.x),y:Math.round(r.y),width:Math.round(r.width),height:Math.round(r.height)})),this._canvas.addShape(a,n.parent)},BpmnImporter.prototype._getConnectedElement=function(e,t){var n,r,i=e.$type;if(r=e[t+"Ref"],"source"===t&&"bpmn:DataInputAssociation"===i&&(r=r&&r[0]),("source"===t&&"bpmn:DataOutputAssociation"===i||"target"===t&&"bpmn:DataInputAssociation"===i)&&(r=e.$parent),n=r&&this._getElement(r))return n;throw r?notYetDrawn(e,r,t+"Ref"):new Error(`${elementToString(e)}#${t} Ref not specified`)},BpmnImporter.prototype._getSource=function(e){return this._getConnectedElement(e,"source")},BpmnImporter.prototype._getTarget=function(e){return this._getConnectedElement(e,"target")},BpmnImporter.prototype._getElement=function(e){return this._elementRegistry.get(e.id)};